<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/iron-meta/iron-meta.html">

<dom-module id="sc-chinese-lookup">
    <template>
        <iron-ajax
        id="ajax"
        handle-as="json"
        loading="{{loadingDict}}"
        last-response="{{dictData}}"></iron-ajax>

        <iron-ajax
        id="fallback_ajax"
        handle-as="json"
        loading="{{loadingFallbackDictData}}"
        last-response="{{fallbackDictData}}"></iron-ajax>

        <iron-meta id="meta"></iron-meta>

    </template>

    <script>
        class SCChineseLookup extends ReduxMixin(Polymer.Element) {
            static get is() {
                return 'sc-chinese-lookup';
            }

            static get properties() {
                return {
                    loadedLanguage: {
                        type: String
                    },
                    toLang: {
                        type: String,
                        statePath: 'textOptions.chineseLookupTargetLanguage',
                        observer: '_targetLanguageChanged'
                    },
                    dictData: {
                        type: Object,
                    },
                    loadingDict: {
                        type: Boolean,
                        value: true
                    },
                    loadingFallbackDictData: {
                        type: Boolean,
                        value: true
                    },
                    fallbackDictData: {
                        type: Object
                    }
                }
            }

            getNewDict() {
                this.$.ajax.url = this._computeUrl();
                this.loadedLanguage = this.toLang;
                if(this.toLang === 'en'){
                    this.$.fallback_ajax.url = this._computeUrl(true);
                    this.$.fallback_ajax.generateRequest();
                }
                return this.$.ajax.generateRequest();
            }

            lookup(graphs) {
                let definition = '';
                
                for (let i = graphs.length; i > 0; i--) {
                    let snip = graphs.slice(0, i);
                    definition += this._lookupWord(snip);
                }
        
                return definition;
            }

            _lookupWord(graph){
                graph = graph.replace(/\u2060/, '');
                if (this.dictData.dictionary[graph]) {
                    const href = `http://www.buddhism-dict.net/cgi-bin/xpr-ddb.pl?q=${encodeURI(graph)}`;
                    return `<tr>
                              <td class="ideograph">
                                <a title="Go to full entry at the DDB. Login with user name ‘guest’" 
                                   href="${href}" target="_blank">${graph}
                                </a>
                              </td>
                              <td class="meaning"> 
                                ${this.dictData.dictionary[graph][0]}: ${this.dictData.dictionary[graph][1]}
                              </td>
                            </tr>`;

                } else if (this.fallbackDictData.dictionary[graph]) {
                    const href = `http://www.buddhism-dict.net/cgi-bin/dealt-lookup?q=${encodeURI(graph)}`;
                    return `<tr class="fallback">
                              <td class="ideograph">
                                <a title="Go to full entry at the CJKV. Login with user name ‘guest’"
                                   href="${href}" target="_blank">${graph}
                                </a>
                              </td>
                              <td class="meaning">
                                ${this.fallbackDictData.dictionary[graph][0]}: ${this.fallbackDictData.dictionary[graph][1]}
                              </td>
                            </tr>`
                }
                return '';
            }

            _computeUrl(fallback) {
                fallback = fallback || false;
                const apiRoot = this.$.meta.byKey('API_ROOT');
                console.log(`${apiRoot}/dictionaries/lookup?from=lzh&to=${this.toLang}&fallback=${fallback}`);
                return `${apiRoot}/dictionaries/lookup?from=lzh&to=${this.toLang}&fallback=${fallback}`;
            }

            _targetLanguageChanged() {
                if(typeof this.toLang !== 'undefined' && this.toLang !== this.loadedLanguage){
                  this.getNewDict();
                }
            }
  
        }

        customElements.define(SCChineseLookup.is, SCChineseLookup);
    </script>
</dom-module>