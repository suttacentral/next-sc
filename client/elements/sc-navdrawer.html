<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/app-route/app-route-converter.html">
<link rel="import" href="../bower_components/iron-location/iron-query-params.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">

<link rel="import" href="paper-tree-sc/paper-tree.html">
<link rel="import" href="page-selector.html">

<!--
The navdrawer is the first element that is called and it loads the navigation-drawer (`app-drawer`) and populates
this with the menu-tree through `paper-tree-sc` (**paper-tree.html** and **paper-tree-node.html**), parses the route
through `app-route` and feeds all information through to the **page-selector.html**.

**app-drawer**

**iron-location** and **app-rout**
These parse the url given but at the moment only deal with the following url:
    - search pages: `/search?query=searchterm`
    - url with one or two terms i.e. `/`, `/dons`, `/dn`, `/dn/vagga1`, `/mn123/sujato', `/define/dictionaryterm`, etc.
     but not with more than 2 terms.

Issues that need to be fixed:
    - It should be possible to parse longer url with more terms. This depends on the various possibilities in the new
    menu with real data.  For instance, it should be able to parse something like `/sn/vagga1/samyutta1/pannasa1/vagga1`
     but this is to be discussed with Bhante Sujato. This also has an effect on the **page-selector.html** and
     the **sc-view-suttaplex.html**.
-->
<dom-module id="sc-navdrawer">
  <template>
    <style>
      :host {
        background-color: grey;
        --app-drawer-width: 240px;
      }

      :host([is-wide]) {
        --app-drawer-width: 360px;
      }

      paper-tree {
        @apply --sc-sans-font;
      }

      #container {
        padding-top: 1em;
      }

      #wheel {
        color: white;
        font-size: 45px;
        display: inline-block;
        vertical-align: middle;
        @apply --sc-serif-font;
      }

      #hometitle {
        @apply --sc-serif-font;
        @apply --sc-mixed-small-caps;
        font-size: 24px;
        font-weight: normal;
        color: var(--paper-indigo-500);
        background-color: var(--paper-amber-400);
        border-bottom: 4px solid var(--paper-deep-orange-900);
        margin: 0;
        padding: 0 0 0 16px;
        white-space: nowrap;
        height: 60px;
        line-height: 1.4;
      }

      #hometitle a {
        color: var(--paper-indigo-500);
        text-decoration: none;
      }

      #drawerbox {
        @apply --shadow-elevation-16dp;
        overflow: auto;
        height: 100%;
      }

      .paper-spinner {
        --paper-spinner-color: var(--sc-gold-500);
        left: 50%;
      }

    </style>

    <iron-media-query query="(min-width: 992px)" query-matches="{{wideScreen}}"></iron-media-query>

    <iron-location path="{{path}}" query="{{query}}"></iron-location>

    <iron-query-params
        params-string="{{query}}"
        params-object="{{queryParams}}">
    </iron-query-params>

    <app-route-converter
        path="{{path}}"
        query-params="{{queryParams}}"
        route="{{route}}">
    </app-route-converter>

    <app-route route="{{route}}"
               pattern="/:collection"
               data="{{collectionData}}"
               tail="{{pathDataTail}}">
    </app-route>

    <app-route
        route="{{pathDataTail}}"
        pattern="/:subpath"
        data="{{subPathData}}"
        active="{{subPathIsActive}}">
    </app-route>

    <iron-ajax
        auto
        url="api/menu"
        handle-as="json"
        loading="{{loading}}"
        last-response="{{navList}}"
        on-response="_parseNavList"
    ></iron-ajax>

    <app-drawer-layout fullbleed responsive-width="840px">

      <app-drawer slot="drawer">
        <div id="drawerbox">
          <div id="hometitle">
            <a href="/">
              <div id="wheel">â˜¸</div>&nbsp;SuttaCentral</a>
          </div>
          <div id="container">
            <template is="dom-if" if="{{loading}}">
              <div class="loadingIndicator">
                <paper-spinner-lite class="paper-spinner" active="{{loading}}"></paper-spinner-lite>
              </div>
            </template>

            <template is="dom-repeat" items="{{navList}}">
              <paper-tree data='{{item}}'></paper-tree>
            </template>
          </div>
        </div>
      </app-drawer>

      <page-selector category="[[category]]" sub-path="[[subPathData.subpath]]" active-path="[[subPathIsActive]]"
                     input-language="[[inputLanguage]]" query-params="[[queryParams]]"></page-selector>

    </app-drawer-layout>
  </template>

  <script>
      class SCNavdrawer extends Polymer.Element {
          static get is() {
              return 'sc-navdrawer'
          }

          static get properties() {
              return {
                  route: Object,
                  inputLanguage: {
                      type: String,
                      notify: true
                  },
                  collectionData: {
                      type: Object,
                      notify: true,
                      observer: '_calculateCategory'
                  },
                  category: {
                      type: String,
                      notify: true
                  },
                  queryParams: Object,
                  path: String,
                  query: String,
                  wideScreen: {
                      type: Boolean,
                      observer: '_screenWidthChanged'
                  }
              }
          }

          static get observers() {
              return ['_updateScroll(route)']
          }

          ready() {
              super.ready();
              // listens to input from the language dropdown menu on the top right
              this.addEventListener('languageSelection', (e) => this.changeLanguage(e));
              // listens to input from the search bar (i.e. a search-term) and feeds this to the iron-location
              this.addEventListener('search', (e) => this.initiateSearch(e));
              // triggered when the menu button in the toolbar is pressed when the app-drawer is not visible
              this.addEventListener('toggleDrawer', (e) => this._toggleDrawer(e));
          }

          connectedCallback() {
              super.connectedCallback();
              console.dir();
          }

          _parseNavList() {
              console.log(this.navList);
          }

          // Set the width of the nav drawer
          _screenWidthChanged() {
              const hostAttributes = this.$.container.__dataHost.attributes;
              if (this.wideScreen) {
                  hostAttributes.setNamedItem(document.createAttribute('is-wide'))
              }
              else if (hostAttributes.getNamedItem('is-wide')) {
                  hostAttributes.removeNamedItem('is-wide')
              }
          }

          _updateScroll() {
              window.scroll(0, 0);
          }

          // Polymer problem here with loading anything with a dot in the path. Bug report filed.
          // So when using "polymer serve" to start development server, you have to use a colon
          // instead of a dot. But with python server/app.py you can use the correct path name.
          _calculateCategory(collectionData) {
              this.category = collectionData.collection.replace(':', '.');
          }

          // sets the inputLanguage for all pages
          changeLanguage(event) {
              return this.inputLanguage = event.detail.Language;
          }

          // opens the app-drawer when it is not visible.
          _toggleDrawer(event) {
              return this.shadowRoot.querySelector('app-drawer').setAttribute('opened', event.detail.togdraw);
          }

          initiateSearch(event) {
              this.set('path', '/search');
              this.set('query', `query=${event.detail}`);
          }
      }

      customElements.define(SCNavdrawer.is, SCNavdrawer);
  </script>
</dom-module>