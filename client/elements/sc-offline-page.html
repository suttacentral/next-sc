<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/app-localize-behavior/app-localize-behavior.html">

<link rel="import" href="../styles/static-styles.html">
<link rel="import" href="addons/sc-static-page.html">
<link rel="import" href="html-imports/sc-languages-import.html">
<link rel="import" href="html-imports/sc-request-queue-import.html">

<dom-module id="sc-offline-page">
  <template>
    <style include="static-styles">

      .button {
        @apply --sc-skolar-font-size-s;
        background-color: var(--sc-primary-accent-color);
        color: var(--sc-tertiary-text-color);
        font-weight: bold;
        text-align: center;
        margin: var(--sc-size-lg);
      }

      .button[disabled] {
        background-color: var(--sc-paper-tooltip-color);
      }

      .button-container {
        margin-top: var(--sc-size-md);
        display: flex;
        flex-direction: row;
        justify-content: flex-end;
      }

      .icon {
        margin: var(--sc-size-sm);
      }

      .success-icon {
        color: var(--sc-toast-success-color);
      }

      .failure-icon {
        color: var(--sc-toast-error-color);
      }

      #download_controller {
        width: 100%;
        will-change: opacity;
        transition: opacity cubic-bezier(0.4, 0.0, 0.2, 1) 300ms;
        margin: var(--sc-size-md);
        background-color: var(--sc-secondary-background-color);
      }

      #cache_progress {
        --paper-progress-active-color: var(--sc-primary-accent-color);
        --paper-progress-container-color: var(--sc-primary-background-color);
        width: 100%;
      }

      .download-progress-percentage {
        @apply --sc-sans-font;
        @apply --sc-skolar-font-size-s;
        margin: var(--sc-size-md);
        text-align: right;
      }

      .download-current-url {
        @apply --sc-sans-font;
        @apply --sc-skolar-font-size-s;
        margin: var(--sc-size-md);
      }

      .control-button-row {
        display: flex;
        justify-content: center;
        color: var(--sc-disabled-text-color);
      }

      .control-button {
        width: var(--sc-size-xl);
        height: var(--sc-size-xl);
      }

      .download-info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .tooltip {
        --paper-tooltip-opacity: 0.98;
        --paper-tooltip-background: var(--sc-paper-tooltip-color);
        --paper-tooltip: {
          @apply --sc-sans-font;
          @apply --sc-skolar-font-size-xs;
          line-height: var(--sc-size-md);
          padding: var(--sc-size-sm) var(--sc-size-md);
          text-shadow: 0 0 var(--sc-secondary-background-color);
          white-space: normal;
          max-width: 100% !important;
        }
      }

      @media screen and (max-width: 600px) {
        .button-container {
          flex-direction: column-reverse;
        }

        .button {
          height: var(--sc-size-xxl);
        }

        .no-phone-top-margin {
          margin-top: 0;
        }
      }

    </style>

    <iron-ajax id="ajax" reject-with-request="true"></iron-ajax>

    <iron-meta id="meta"></iron-meta>

    <div id="page-wrap">
      <main>
        <section>
          <article>
            <h1>{{localize('usingOffline')}}</h1>
            <p inner-h-t-m-l="{{localize('pwaDescription')}}"></p>
            <p>{{localize('additionalInfo')}}</p>
            <p>{{localize('newTech')}}</p>
            <ul>
              <li>{{localize('suttasOnly')}}</li>
              <li>{{localize('oneLang')}}</li>
              <li>{{localize('noOriginal')}}</li>
              <li>{{localize('certainFunctions')}}</li>
            </ul>
            <p>{{localize('extraFeatures')}}</p>

            <div class="button-container">
              <paper-button id='make_offline_button' class="button" raised
                            disabled="[[_isDownloadButtonDisabled(browserSupportsPWA, cacheDownloadInProgress)]]">
                {{localize('downloadButton', 'languageName', languageName)}}
              </paper-button>
              <div class="button-info">
                <p class="no-phone-top-margin">
                  <template is="dom-if" if="[[browserSupportsPWA]]">
                    <span>{{localize('supportsPWAs')}}</span>
                    <iron-icon icon="icons:check-box" class="icon success-icon"></iron-icon>
                  </template>
                  <template is="dom-if" if="[[!browserSupportsPWA]]">
                    <span>{{localize('doesntSupportPWAs')}}</span>
                    <iron-icon icon="icons:error" class="icon failure-icon"></iron-icon>
                    <br>
                    <a href="https://caniuse.com/#feat=serviceworkers">
                      {{localize('listBrowsers')}}
                    </a>
                  </template>
                </p>
                <p>
                  {{localize('selectDifferentLang')}}
                </p>
              </div>
            </div>
            <paper-card id="download_controller">
              <div class="download-info-row">
                <div class="download-current-url">{{localize('downloading')}}: [[currentDownloadingUrl]]</div>
                <div class="control-button-row">
                  <paper-icon-button id="play_button" class="control-button" icon="av:play-arrow"></paper-icon-button>
                  <paper-tooltip for="play_button" class="tooltip">
                    [[_getPlayButtonTooltip(isDownloadPaused, localize)]]
                  </paper-tooltip>
                  <paper-icon-button id="stop_button" class="control-button" icon="av:stop"></paper-icon-button>
                  <paper-tooltip for="stop_button" class="tooltip">
                    {{localize('stop')}}
                  </paper-tooltip>
                </div>
              </div>
              <paper-progress id="cache_progress"></paper-progress>
              <template is="dom-if" if="[[cacheDownloadInProgress]]">
                <div class="download-progress-percentage">
                  [[downloadProgressPercentage]]%
                </div>
              </template>
            </paper-card>
          </article>
        </section>
      </main>
    </div>
  </template>

  <script>
      /**
       * @extends {Polymer.Element}
       * @appliesMixin Polymer.AppLocalizeBehavior
       */
      class SCOfflinePage extends SCStaticPage {
          static get is() {
              return 'sc-offline-page';
          }

          static get properties() {
              return {
                  localizedStringPath: {
                      type: String,
                      value: '/localization/elements/sc-offline-page/'
                  },
                  browserSupportsPWA: {
                      type: Boolean,
                      computed: '_doesBrowserSupportPWA()'
                  },
                  languageName: {
                      type: String,
                      computed: '_getNativeLanguageName(language)'
                  },
                  cacheDownloadInProgress: {
                      type: Boolean,
                      observer: '_downloadInProgressChanged',
                      value: false
                  },
                  downloadProgressPercentage: {
                      type: Number,
                      value: 0
                  },
                  currentDownloadingUrl: {
                      type: String
                  },
                  isDownloadPaused: {
                      type: Boolean,
                      observer: '_downloadPausedChanged',
                      value: true
                  },
                  downloadQueue: {
                      type: Object
                  }
              }
          }

          connectedCallback() {
              super.connectedCallback();
              const offlineButton = this.$.make_offline_button;
              if (offlineButton) {
                  offlineButton.addEventListener('click', () => { this.makeOffline() });
              }
              this.$.play_button.addEventListener('click', () => { this._resumeOrPauseDownload() });
              this.$.stop_button.addEventListener('click', () => { this._stopDownload() });
              this._handleNetworkLoss();
          }

          _handleNetworkLoss() {
              window.addEventListener('offline', () => {
                  if (!this.downloadQueue) return;
                  this.downloadQueue.pause();
                  this._showToast('info', this.localize('networkLost'));
              });
              window.addEventListener('online', () => {
                  if (!this.downloadQueue) return;
                  this.downloadQueue.resume();
                  this._showToast('info', this.localize('networkRecovered'));
              });
          }

          makeOffline() {
              this.$.ajax.url = this._getCollectionUrl('sutta');
              this._showToast('info', `Your download has commenced.
                You can keep using the site and we will let you know when itâ€™s complete.`);
              this.cacheDownloadInProgress = true;
              this.$.ajax.generateRequest().completes.then(
                  (request) => {
                      this.downloadProgressPercentage = 0;
                      const response = request.__data.response;
                      const allURLs = this._buildUrlList(response);
                      this._cacheAllItems(allURLs);
                  }, (error) => {
                      this._showToast('error', 'Network error.');
                      this.cacheDownloadInProgress = false;
                      console.error(error.error);
                  });
          }

          _cacheAllItems(allURLs) {
              let failed = 0;
              let passed = 0;
              const progressBar = this.$.cache_progress;
              progressBar.value = 0;
              this.isDownloadPaused = false;
              this.downloadQueue = new RequestQueue({ rateLimit: 10 }, {
                  item: (input, done) => {
                      fetch(input.url)
                          .then(this._handleErrors)
                          .then(() => {
                              passed++;
                              this._updateUi(progressBar, input.url);
                              done();
                          })
                          .catch((err) => {
                              failed++;
                              this.isDownloadPaused = true;
                              console.error(err)
                          })
                  },
                  end: () => {
                      this.cacheDownloadInProgress = false;
                      this.isDownloadPaused = true;
                      if (failed === 0) {
                          this._showToast('success', `Your download is complete.
                            You may now read suttas in ${this._getNativeLanguageName(this.language)} offline.`);
                      } else if (failed > 0 && passed > 0) {
                          this._showToast('error', `Error! We were not able to download all the requested texts.
                            ${failed} out of ${passed + failed} requests did not complete correctly.`);
                      } else {
                          this._showToast('error', 'Network error.');
                      }
                  }
              });

              allURLs.forEach(this.downloadQueue.enqueue, this.downloadQueue);
              progressBar.max = this.downloadQueue.length();
          }

          _updateUi(progressBar, currentUrl) {
              progressBar.value++;
              this.downloadProgressPercentage = Math.round(progressBar.value / progressBar.max * 100);
              this.currentDownloadingUrl = currentUrl.slice(currentUrl.indexOf('api') + 4);
          }

          _downloadPausedChanged() {
              this.$.play_button.icon = this.isDownloadPaused ? 'av:play-arrow' : 'av:pause';
          }

          _downloadInProgressChanged() {
              this.$.download_controller.style.opacity = this.cacheDownloadInProgress ? 1 : 0;
          }

          _buildUrlList(response) {
              const menuURLs = response.menu.map(menuId => this._getMenuUrl(menuId));
              const suttaplexURLs = response.suttaplex.map(suttaplexId => this._getSuttaplexUrl(suttaplexId));
              const suttaTextURLs = [];
              response.texts.forEach((text) => {
                  text.translations.forEach((translation) => {
                      translation.authors.forEach((author) => {
                          suttaTextURLs.push(this._getSuttaTextUrl(text.uid, author, translation.lang));
                      })
                  })
              });
              return menuURLs.concat(suttaplexURLs).concat(suttaTextURLs);
          }

          _handleErrors(response) {
              if (!response.ok) {
                  throw Error(response.statusText);
              }
              return response;
          }

          _getCollectionUrl(collection) {
              return `${this.$.meta.byKey('API_ROOT')}/pwa/collection/${collection}?languages=${this.language}`;
          }

          _getMenuUrl(menuItemId) {
              return `${this.$.meta.byKey('API_ROOT')}/menu/${menuItemId}?language=${this.language}`;
          }

          _getSuttaplexUrl(suttaplexId) {
              return `${this.$.meta.byKey('API_ROOT')}/suttaplex/${suttaplexId}?language=${this.language}`;
          }

          _getSuttaTextUrl(suttaId, authorId, langIsoCode) {
              return `${this.$.meta.byKey('API_ROOT')}/suttas/${suttaId}/${authorId}?lang=${langIsoCode}`;
          }

          _doesBrowserSupportPWA() {
              return ('serviceWorker' in navigator);
          }

          _getNativeLanguageName(languageIsoCode) {
              return languages.getLanguageInfo(languageIsoCode).nativeName;
          }

          _isDownloadButtonDisabled(browserSupportsPWAs, cacheDownloadInProgress) {
              return !browserSupportsPWAs || cacheDownloadInProgress;
          }

          _getPlayButtonTooltip(isDownloadPaused, localize) {
              return isDownloadPaused ? localize('resume') : localize('pause');
          }

          _resumeOrPauseDownload() {
              this.isDownloadPaused ? this.downloadQueue.resume() : this.downloadQueue.pause();
              this.isDownloadPaused = !this.isDownloadPaused;
          }

          _stopDownload() {
              this.downloadQueue.pause();
              delete this.downloadQueue;
              this.cacheDownloadInProgress = false;
              this._showToast('info', this.localize('canceled'))
          }

          _showToast(type, inputMessage) {
              this.dispatchEvent(new CustomEvent('show-sc-toast', {
                  detail: {
                      toastType: type,
                      message: inputMessage
                  },
                  bubbles: true,
                  composed: true
              }));
          }
      }

      customElements.define(SCOfflinePage.is, SCOfflinePage);
  </script>
</dom-module>