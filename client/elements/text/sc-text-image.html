<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-meta/iron-meta.html">

<link rel="import" href="../../elements/text/sc-viewer-import.html">
<link href="../../node_modules/viewerjs/dist/viewer.min.css" rel="stylesheet">

<dom-module id="sc-text-image">
  <template>

    <style>
        .hide {
            display: none;
        }
    </style>
    
    <iron-meta id="meta"></iron-meta>

    <iron-ajax
        id="ajax"
        debounce-duration="500"
        handle-as="json"
        loading="{{isLoading}}"
        last-error="{{lastError}}"
        last-response="{{imageData}}"
        on-response="_handleResponse"></iron-ajax>

        <div class="hide">
          <img id="image" class="image" src="[[showUrl]]" alt="[[imageAlt]]">
        </div>
  </template>

  <script>
      class SCTextImage extends Polymer.Element {
          static get is() {
              return 'sc-text-image';
          }

          static get properties() {
              return {
                  division: {
                      type: String
                  },
                  vol: {
                      type: String
                  },
                  pageNumber: {
                    type: Number
                  },
                  isLoading: {
                      type: Boolean,
                      value: false
                  },
                  lastError: {
                      type: Object
                  },
                  imageData: {
                      type: Array
                  },
                  viewer: {
                      type: Object
                  },
                  lastDetail: {
                      type: Object
                  },
                  showUrl: {
                      type: String,
                      computed: '_getShowUrl(imageData)'
                  },
                  imageAlt: {
                      type: String,
                      computed: '_getImageAlt(imageData)'
                  }
              }
          }

          showImage(detail) {
            if (!detail || this._didDetailChange(detail)) {
              return;
            };
            this.lastDetail = detail;
            this.division = detail.division;
            this.vol = detail.vol;
            this.pageNumber = detail.pageNumber;
            this.$.ajax.url = this._getUrl();
            this.$.ajax.generateRequest();
          }

          _getShowUrl(imageData) {
              return this._getImageUrl(imageData[0].name);
          }

          _getImageAlt(imageData) {
              return imageData[0].name;
          }

          _didDetailChange(detail) {
            if (this.lastDetail && 
                detail.vol === this.lastDetail.vol && 
                detail.division === this.lastDetail.division && 
                detail.pageNumber === this.lastDetail.pageNumber) {
                return true;
            } else {
                return false;
            }
          }

          _getUrl() {
            return `${this.$.meta.byKey('API_ROOT')}/images/${this.division}/${this.vol}/${this.pageNumber}`;
          }

          _getImageUrl(name) {
            return `${this.$.meta.byKey('IMAGES_ROOT')}/${name}`;
          }

          _handleResponse() {
              if (!this.imageData || !this.imageData[0]) {
                return;
              };
              requestAnimationFrame(() => {
                  const options = {
                    url: `'src'`,
                    navbar: false,
                    transition: false,
                    toolbar: {
                      zoomIn: 2,
                      zoomOut: 2,
                      oneToOne: 2,
                      reset: 0,
                      prev: 0,
                      play: {
                        show: 0,
                        size: 'large',
                      },
                      next: 0,
                      rotateLeft: 0,
                      rotateRight: 0,
                      flipHorizontal: 0,
                      flipVertical: 0,
                    }
                  }
                  if(this.viewer){
                    this.viewer.reset();
                  } else {
                    this.viewer = new Viewer(this.$.image, options);
                  }
                  this.viewer.index = 0;
                  this.viewer.show();
                  this.lastDetail = {};
              });
          }
      }

      customElements.define(SCTextImage.is, SCTextImage);
  </script>
</dom-module>
