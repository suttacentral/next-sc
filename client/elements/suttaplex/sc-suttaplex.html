<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="/bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="/bower_components/paper-styles/paper-styles.html">
<link rel="import" href="/bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/paper-card/paper-card.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/paper-toast/paper-toast.html">

<link rel="import" href="/img/sc-svg-icons.html">
<link rel="import" href="/elements/addons/sc-sutta-note.html">
<link rel="import" href="/elements/menus/language-menu.html">
<link rel="import" href="/elements/menus/more-par-menu.html">
<link rel="import" href="/elements/suttaplex/sc-view-parallels.html">
<link rel="import" href="/elements/addons/sc-badge.html">

<!--
  Suttaplex card
-->
<dom-module id="sc-suttaplex" attributes="open url">
  <template>
    <style include="sc-suttaplex-styles">
      .heading {
        cursor: pointer;
      }

      .suttaplex-head-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      h1, h2, h3 {
        margin: 0;
      }

      paper-card.suttaplex {
        border-radius: 0;
        border-top: 1px solid var(--paper-grey-300);
        display: block;
      }

      paper-card.suttaplex .card-content {
        padding-top: 24px;
        padding-bottom: 1px;
      }

      .suttaplex-heading {
        @apply --paper-font-headline;
        @apply --sc-serif-font;
      }

      .suttaplex-nerdy-row {
        @apply --paper-font-body2;
        color: var(--secondary-text-color);
        font-weight: normal;
        white-space: nowrap;
        overflow: hidden;
      }

      .nerdy-row-element {
        margin-right: 24px;
      }

      .suttaplex-description {
        @apply --sc-paper-font-body;
        overflow: hidden;
      }

      paper-card.suttaplex .card-actions {
        padding: 0 var(--size-md);
        display: flex;
        flex-flow: wrap;
        flex-grow: 1;
        justify-content: space-between;
        align-items: baseline;
        border-top: 0;
      }

      .card-actions-left {
        display: inline-block;
        align-self: flex-start;
      }

      .card-actions-left paper-button:first-of-type {
        margin-left: 0;
        padding-left: 0;
      }

      .right-elements {
        display: flex;
        align-self: flex-end;
      }

      .flex-div {
        display: flex;
        justify-content: space-between;
        flex: 1;
      }

      .vert-menu {
        display: inline-block;
      }

      .languagedrop {
        display: inline-block;
        vertical-align: middle;
        margin: -18px 4px 0;
        width: 100px;
      }

      #moremenu {
        visibility: hidden;
      }

      summary::-webkit-details-marker {
        color: var(--paper-grey-300);
      }

      details {
        display: inline-block;
      }

      details p {
        @apply --paper-font-body1;
        @apply --shadow-elevation-3dp;
        position: absolute;
        z-index: 200;
        background-color: #fff;
        padding: 12px;
        border-top: 1px solid rgba(0, 0, 0, 0.12);
        margin: 0 48px 0 0;
        white-space: normal;
      }

      paper-menu-button {
        padding: 0;
      }

      .notfound {
        @apply --paper-font-display1;
      }

      .hide-element {
        display: none;
      }

      .difficulty-icon {
        padding-right: 8px;
      }

      .toggle-button {
        min-width: 40px;
        align-self: flex-end;
        z-index: 201;
      }

      .behind-button {
        z-index: 200;
      }

      .more-info {
        align-self: flex-end;
      }

      .paper-badge {
        --paper-badge-margin-left: -15px;
        --paper-badge-margin-bottom: -10px;
      }

      .display-inline {
        display: inline-block;
      }

      .volpage-biblio-info-summary {
        outline: none;
        cursor: pointer;
      }

      .volpage-biblio-info {
        @apply --paper-font-body1;
        position: absolute;
        z-index: 200;
        background-color: #fff;
        @apply --shadow-elevation-3dp;
        padding: 12px;
        border-top: 1px solid rgba(0, 0, 0, 0.12);
        margin: 0 48px 0 0;
        white-space: normal;
      }

      .no-margin {
        margin: 0;
      }

      .parallels-toggle-div {
        display: inline-grid;
        position: relative;
      }

      .absolute-pos {
        position: absolute;
      }

      .no-left-padding {
        padding-left: 0;
      }

      .top-space {
        margin-top: 24px;
      }

    </style>

    <paper-card class="suttaplex" id="[[item.uid]]">
      <div class="card-content">

        <div class="suttaplex-head-container">
          <h3 class="suttaplex-heading">[[_computeMainHeading(item)]]</h3>
          <div class$="difficulty-icon [[item.difficulty.name]]"
               title="Recommended for [[item.difficulty.name]] students">
            <iron-icon icon="[[_computeLevel(item.difficulty.name)]]"></iron-icon>
          </div>
        </div>

        <div class="suttaplex-nerdy-row">
          <span title="Original title" class$="[[_computeHideOriginalTitle(item)]] nerdy-row-element">
            [[item.original_title]]
          </span>
          <span title="SuttaCentral ID" class$="[[_computeHideUID(item)]] nerdy-row-element">[[item.acronym]]</span>
          <template is="dom-if" if="[[item.volpages]]">
            <template is="dom-if" if=[[!item.biblio]]>
              <span class="book" class="no-margin"><iron-icon icon="book"></iron-icon></span>
              <span class="vol-page nerdy-row-element" title="Volume and page">[[item.volpages]]</span>
            </template>
            <template is="dom-if" if=[[item.biblio]]>
              <details class="display-inline">
                <summary class="volpage-biblio-info-summary">
                  <span class="book" class="no-margin"><iron-icon icon="book"></iron-icon></span>
                  <span class="vol-page nerdy-row-element" title="Volume and page">[[item.volpages]]</span>
                </summary>
                <p class="volpage-biblio-info" inner-h-t-m-l="[[item.biblio]]"></p>
              </details>
            </template>
          </template>
        </div>

        <p class$="suttaplex-description [[_computeHide(item.blurb)]]" title="Description"
           inner-h-t-m-l="[[item.blurb]]"></p>
      </div>

      <div class$="{{_addPaddingIfNoBlurb(item.blurb)}} card-actions">
        <div class="card-actions-left">
          <template is="dom-repeat" items="[[item.translations]]" as="translation">
            <template is="dom-if" if="{{_isChosenLang(translation.lang)}}">
              <paper-button flat title$="Go to a translation by [[_capitalize(translation.author)]]">
                <a href="[[_getSuttaTextUrl(item.uid, translation.lang, translation.author)]]">
                  [[translation.author]]
                </a>
              </paper-button>
            </template>
          </template>
        </div>
        <div class="flex-div">
          <div class="languagedrop">
            <language-menu language-choice="[[item.translations]]" title-label="More"
                           input-language="[[inputLanguage]]" original-language="[[item.root_lang]]"
                           root-id="[[item.uid]]" on-paper-dropdown-close="_changeItemZIndex"
                           on-paper-dropdown-open="_changeItemZIndex" class="no-left-padding"></language-menu>
          </div>

          <div class="right-elements">
            <div class="vert-menu">
              <paper-menu-button id="copy_menu" horizontal-align="right" role="group" aria-haspopup="true"
                                 vertical-align="top" aria-disabled="false">
                <paper-icon-button class="more-info" slot="dropdown-trigger" icon="icons:more-vert" role="button"
                                   tabindex="0" aria-disabled="false"></paper-icon-button>
                <div slot="dropdown-content"></div>
                <paper-listbox slot="dropdown-content" tabindex="0" role="listbox">
                  <more-par-menu id="more_par_menu" tabindex="0" item="[[item]]">
                  </more-par-menu>
                </paper-listbox>
              </paper-menu-button>
            </div>

            <template is="dom-if" if="[[item.parallel_count]]">
              <div class="parallels-toggle-div">
                <paper-icon-button id="parallels_toggle" class="toggle-button" icon="[[toggleIcon]]"
                                   on-tap="_toggleParallelsOpened">
                </paper-icon-button>
                <sc-badge class="absolute-pos behind-button" number="[[item.parallel_count]]"></sc-badge>
              </div>
            </template>
          </div>
        </div>
      </div>

      <template is="dom-if" if="[[parallelsOpened]]">
        <iron-collapse no-animation id="collapse" opened="{{parallelsOpened}}">
          <sc-view-parallels root-lang="[[item.root_lang]]" item-uid="[[item.uid]]"></sc-view-parallels>
        </iron-collapse>
      </template>

    </paper-card>
  </template>

  <script>
      class SCSuttaplex extends Polymer.Element {
          static get is() {
              return 'sc-suttaplex';
          }

          static get properties() {
              return {
                  toggleIcon: {
                      type: String,
                      computed: '_computeToggleIcon(parallelsOpened)'
                  },
                  parallelsOpened: {
                      type: Boolean,
                      value: false,
                      observer: '_parallelsOpenedChanged'
                  },
                  opened: {
                      type: Boolean,
                      reflectToAttribute: true,
                      notify: true
                  },
                  _toggleIcon: {
                      type: String,
                      computed: '_computeToggleIcon(opened)'
                  },
                  _toggleMoreIcon: {
                      type: String,
                      computed: '_computeToggleMoreIcon(opened)'
                  },
                  inputLanguage: {
                      type: String,
                      value: 'en' // Temporary hardcoded
                  },
                  level: String,
                  // The suttaplex item
                  item: {
                      type: Object
                  },
                  toastMessage: {
                      type: String
                  }
              }
          }

          ready() {
              super.ready();
              this.addEventListener('par-menu-copied', (e) => {
                  this.$.copy_menu.opened = false;  // Close dropdown after the copy action.
              })

              this.$.copy_menu.addEventListener('opened-changed', (e) => {
                  const open = e.detail.value;
                  if (open) {
                      this.$.more_par_menu._sendRequest();
                  }
                  const type = open ? 'open' : 'close';
                  const event_mock = { type: type };
                  this._changeItemZIndex(event_mock);
              })
          }

          _changeItemZIndex(e) {
              let node = this.parentNode;
              if (node.style === undefined) {
                  return;
              }
              if (e.type.endsWith('open')) {
                  node.style['z-index'] = 100;
              } else if (node.style['z-index'] === '100') {
                  node.style['z-index'] = 0;
              }
          }

          _parallelsOpenedChanged(e) {
              const type = e ? 'open' : 'close';
              const event_mock = { type: type };
              this._changeItemZIndex(event_mock);
          }

          _shouldPullRight(parallelsOpened) {
              return parallelsOpened ? 'pull-right' : '';
          }

          // general function to hide or display various elements.
          _computeHide(checkText) {
              return (!checkText) ? 'hide-element' : '';
          }

          _computeHideUID(item) {
              return (item.translated_title || item.original_title) ? '' : 'hide-element'
          }

          _computeHideOriginalTitle(item) {
              return item.translated_title ? '' : 'hide-element'
          }

          // returns the relevant icon for the expander
          _computeToggleIcon(parallelsOpened) {
              return parallelsOpened ? 'icons:expand-less' : 'icons:expand-more';
          }

          // shows the more-par menu when the expander is opened.
          _computeToggleMoreIcon(opened) {
              return opened ? '' : 'moremenu';
          }

          // adds the 'tree'-icons to denote difficulty level if any.
          _computeLevel(level) {
              return level ? 'sc-svg-icons:' + level : '';
          }

          // Computes API endpoint URL for given translation
          _getSuttaTextUrl(uid, lang, author) {
              const url = window.location;
              const baseUrl = url.protocol + '//' + url.host;
              return `${baseUrl}/${uid}/${lang}/${author}`;
          }

          _isChosenLang(lang) {
              return lang === this.inputLanguage;
          }

          _toggleParallelsOpened() {
              this.parallelsOpened = !this.parallelsOpened;
              this.dispatchEvent(new CustomEvent('iron-resize', { composed: true, bubbles: true }));
          }

          _computeMainHeading(item) {
              if (!item) {
                  return '';
              }
              if (item.translated_title) {
                  return item.translated_title;
              } else if (item.original_title) {
                  return item.original_title;
              } else {
                  return item.acronym;
              }
          }

          _addPaddingIfNoBlurb(blurb) {
            return (blurb === null || blurb === undefined) ? 'top-space' : '';
          }

          _capitalize(author){
            return author.replace(/\b\w/g, l => l.toUpperCase());
          }
      }

      customElements.define(SCSuttaplex.is, SCSuttaplex);
  </script>
</dom-module>
