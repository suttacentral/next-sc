<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-badge/paper-badge.html">

<link rel="import" href="../../styles/sc-styles.html">
<link rel="import" href="../../styles/sc-suttaplex-styles.html">
<link rel="import" href="../../img/sc-svg-icons.html">
<link rel="import" href="../addons/sc-sutta-note.html">
<link rel="import" href="../menus/language-menu.html">
<link rel="import" href="../menus/more-par-menu.html">
<link rel="import" href="sc-view-parallels.html">

<!--
  Suttaplex card
-->
<dom-module id="sc-suttaplex" attributes="open url">
  <template>
    <style is="custom-style" include="sc-suttaplex-styles">
      .heading {
        cursor: pointer;
      }

      .suttaplex-head-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      h1, h2, h3 {
        margin: 0;
      }

      paper-card.suttaplex {
        border-radius: 0;
        border-top: 1px solid var(--paper-grey-300);
        display: block;
      }

      paper-card.suttaplex .card-content {
        padding-top: 24px;
        padding-bottom: 1px;
      }

      .suttaplex-heading {
        @apply --paper-font-headline;
        @apply --sc-serif-font;
      }

      .suttaplex-nerdy-row {
        @apply --paper-font-body2;
        color: var(--secondary-text-color);
        font-weight: normal;
        white-space: nowrap;
        overflow: hidden;
      }

      .suttaplex-nerdy-row span {
        margin-right: 24px;
      }

      .suttaplex-description {
        @apply --sc-paper-font-body;
        overflow: hidden;
      }

      paper-card.suttaplex .card-actions {
        padding: 0 16px 8px;
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        border-top: 0;
      }

      .card-actions-left {
        display: inline-block;
      }

      .card-actions-right {
        display: inline-block;
      }

      .languagedrop {
        display: inline-block;
        vertical-align: middle;
        margin: -18px 4px 0;
        padding: 0 8px;
      }

      paper-badge {
        --paper-badge-background: var(--paper-green-a700);
      }

      #moremenu {
        visibility: hidden;
      }

      summary::-webkit-details-marker {
        color: var(--paper-grey-300);
      }

      details {
        display: inline-block;
      }

      details p {
        @apply --paper-font-body1;
        position: absolute;
        z-index: 200;
        background-color: #fff;
        @apply --shadow-elevation-3dp;
        padding: 12px;
        border-top: 1px solid rgba(0, 0, 0, 0.12);
        margin: 0 48px 0 0;
        white-space: normal;
      }

      paper-menu-button {
        padding: 0;
      }

      .notfound {
        @apply --paper-font-display1;
      }

      .hide-element {
        display: none;
      }

      .difficulty-icon {
        padding-right: 8px;
      }
    </style>

    <paper-card class="suttaplex" id="[[item.uid]]">
      <div class="card-content">

        <div class="suttaplex-head-container">
          <h3 class="suttaplex-heading">[[item.original_title]]</h3>
          <div class$="difficulty-icon [[item.difficulty.name]]"
               title="Recommended for [[item.difficulty.name]] students">
            <iron-icon icon="[[_computeLevel(item.difficulty.name)]]"></iron-icon>
          </div>
        </div>

        <div class="suttaplex-nerdy-row">
          <span title="Original title" class$="[[_computeHide(item.original_title)]]">[[item.original_title]]</span>
          <span title="SuttaCentral ID">[[_toUpper(item.uid)]]</span>
          <template is="dom-if" if="[[item.volpages]]">
            <span class="book" style="margin: 0"><iron-icon icon="book"></iron-icon></span>
            <span class="vol-page" title="Volume and page">[[item.volpages]]</span>
          </template>
        </div>

        <p class$="suttaplex-description [[_computeHide(item.blurb)]]" title="Description">
          [[item.blurb]]</p>
      </div>

      <div class="card-actions">
        <div class="card-actions-left">
          <template is="dom-repeat" items="[[item.translations]]" as="translation">
            <template is="dom-if" if="{{_isChosenLang(translation.lang)}}">
              <paper-button flat title$="Go  to a translation by [[translation.author]]">
                <a href="[[_computeApiUrlEndpoint(item.uid, translation.author)]]">[[translation.author]]</a>
              </paper-button>
            </template>
          </template>
          <div class="languagedrop">
            <language-menu language-choice="[[item.translations]]" title-label="More translations"
                           input-language="[[inputLanguage]]" original-language="[[item.root_lang]]"
                           input-url="item.uid" id="languageMenu" on-paper-dropdown-close="_changeItemZIndex"
                           on-paper-dropdown-open="_changeItemZIndex">
          </div>
        </div>

        <paper-icon-button icon="[[toggleIcon]]" on-tap="_toggleParallelsOpened"></paper-icon-button>
      </div>

      <template is="dom-if" if="[[parallelsOpened]]">
        <iron-collapse no-animation id="collapse" opened="{{parallelsOpened}}">
          <sc-view-parallels item-uid="[[item.uid]]"></sc-view-parallels>
        </iron-collapse>
      </template>

    </paper-card>
  </template>

  <script>
      class Suttaplex extends Polymer.Element {
          static get is() {
              return 'sc-suttaplex'
          }

          static get properties() {
              return {
                  toggleIcon: {
                      type: String,
                      computed: '_computeToggleIcon(parallelsOpened)'
                  },
                  parallelsOpened: {
                      type: Boolean,
                      value: false
                  },
                  opened: {
                      type: Boolean,
                      reflectToAttribute: true,
                      notify: true
                  },
                  _toggleIcon: {
                      type: String,
                      computed: '_computeToggleIcon(opened)'
                  },
                  _toggleMoreIcon: {
                      type: String,
                      computed: '_computeToggleMoreIcon(opened)'
                  },
                  inputLanguage: {
                      type: String,
                      value: 'en' // Temporary hardcoded
                  },
                  level: String
              }
          }

          _changeItemZIndex(e) {
              let node = this.parentNode;
              if (e.type.endsWith('open')) {
                  node.style['z-index'] = 100;
              } else {
                  node.style['z-index'] = null;
              }
          }

          // general function to hide or display various elements.
          _computeHide(checkText) {
              return (!checkText) ? "hide-element" : "";
          }

          // returns the relevant icon for the expander
          _computeToggleIcon(parallelsOpened) {
              return parallelsOpened ? 'icons:expand-less' : 'icons:expand-more';
          }

          // shows the more-par menu when the expander is opened.
          _computeToggleMoreIcon(opened) {
              return opened ? '' : 'moremenu';
          }

          // adds the 'tree'-icons to denote difficulty level if any.
          _computeLevel(level) {
              return level ? "sc-svg-icons:" + level : "";
          }

          // Computes API endpoint URL for given tranlation
          _computeApiUrlEndpoint(uid, author) {
              return `/sutta/${uid}/?author=${author}`
          }

          _isChosenLang(lang) {
              return lang === this.inputLanguage
          }

          _toUpper(text) {
              return text.toUpperCase()
          }

          _toggleParallelsOpened() {
              this.parallelsOpened = !this.parallelsOpened;
              this.dispatchEvent(new CustomEvent('iron-resize', {composed: true, bubbles: true}));
          }
      }

      customElements.define(Suttaplex.is, Suttaplex)
  </script>
</dom-module>
