<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="../../img/sc-svg-icons.html">
<link rel="import" href="../../elements/addons/sc-sutta-note.html">
<link rel="import" href="../../elements/menus/language-menu.html">
<link rel="import" href="../../elements/menus/more-par-menu.html">
<link rel="import" href="../../elements/suttaplex/sc-view-parallels.html">
<link rel="import" href="../../elements/addons/sc-badge.html">

<!--
  Suttaplex card
-->
<dom-module id="sc-suttaplex" attributes="open url">
  <template>
    <style include="sc-suttaplex-styles">
      .heading {
        cursor: pointer;
      }

      .suttaplex-head-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      h1, h2, h3 {
        margin: 0;
      }

      .suttaplex {
        background-color: var(--sc-secondary-background-color);
        margin-top: var(--sc-size-md);
        border-radius: var(--sc-size-xxs);
        display: block;
      }

      .suttaplex .card-content {
        padding-top: var(--sc-size-md-larger);
        padding-bottom: 1px;
      }

      .suttaplex-heading {
        @apply --paper-font-headline;
        @apply --sc-serif-font;
      }

      .suttaplex-nerdy-row {
        @apply --paper-font-body2;
        color: var(--sc-secondary-text-color);
        font-weight: normal;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .suttaplex-nerdy-row:hover {
          text-overflow: clip;
          white-space: normal;
          word-break: break-all;
      }

      .nerdy-row-element {
        margin-right: var(--sc-size-md-larger);
      }

      .suttaplex-description {
        @apply --sc-paper-font-body;
        overflow: hidden;
      }

      paper-card.suttaplex .card-actions {
        padding: 0 var(--sc-size-md) var(--sc-size-sm);
        display: flex;
        flex-flow: wrap;
        flex-grow: 1;
        justify-content: space-between;
        align-items: baseline;
        border-top: 0;
      }

      .card-actions-left {
        display: inline-block;
        align-self: flex-start;
      }

      .card-actions-left paper-button:first-of-type {
        margin-left: -2px;
      }

      .right-elements {
        display: flex;
        align-self: flex-end;
      }

      .flex-div {
        display: flex;
        justify-content: space-between;
        flex: 1;
      }

      .vert-menu {
        --paper-listbox-background-color: var(--sc-secondary-background-color);
      }

      .languagedrop {
        display: inline-block;
        vertical-align: middle;
        margin: -18px var(--sc-size-xs) 0;
      }

      #moremenu {
        visibility: hidden;
      }

      .volpage-biblio-info-summary::-webkit-details-marker {
        color: var(--sc-paper-tooltip-color);
      }

      .suttaplex-details {
        display: inline-block;
      }

      .suttaplex-details .volpage-biblio-info {
        @apply --paper-font-body1;
        position: absolute;
        z-index: 200;
        background-color: #fff;
        padding: 12px;
        border-top: var(--sc-border);
        margin: 0 var(--sc-size-xl) 0 0;
        white-space: normal;
      }

      #copy_menu {
        padding: 0;
      }

      .more-par-listbox:focus,
      #more_par_menu:focus {
        outline: none;
      }

      .notfound {
        @apply --paper-font-display1;
      }

      .hide-element {
        display: none;
      }

      .difficulty-icon {
        padding-right: var(--sc-size-sm);
      }

      .toggle-button {
        min-width: 40px;
        align-self: flex-end;
        z-index: 201;
      }

      .behind-button {
        z-index: 0;
      }

      .more-info {
        align-self: flex-end;
      }

      .paper-badge {
        --paper-badge-margin-left: -15px;
        --paper-badge-margin-bottom: -10px;
      }

      .display-inline {
        display: inline-block;
      }

      .volpage-biblio-info-summary {
        outline: none;
        cursor: pointer;
      }

      .volpage-biblio-info {
        @apply --paper-font-body1;
        position: absolute;
        z-index: 200;
        background-color: #fff;
        padding: 12px;
        border-top: var(--sc-border);
        margin: 0 var(--sc-size-xl) 0 0;
        white-space: normal;
      }

      .scrollable-dialog {
        margin: 0;
      }

      .parallels-toggle-div {
        z-index: 0;
        display: inline-grid;
        position: relative;
      }

      .absolute-pos {
        position: absolute;
      }

      .no-left-padding {
        padding-left: 0;
      }

      .top-space {
        margin-top: var(--sc-size-md-larger);
      }

      .grey-icon {
        color: var(--sc-disabled-text-color);
      }

      .primary-accent-icon {
        color: var(--sc-primary-accent-color);
        stroke: var(--sc-primary-accent-color);
      }

      .author-button {
        @apply --sc-skolar-font-size-md;
      }

      .sc-tooltip {
        --paper-tooltip-opacity: 0.98;
        --paper-tooltip-background: var(--sc-paper-tooltip-color);
        --paper-tooltip: {
          @apply --sc-sans-font;
          @apply --sc-skolar-font-size-xs;
          line-height: var(--sc-size-md);
          padding: var(--sc-size-sm) var(--sc-size-md);
          text-shadow: 0 0 var(--sc-secondary-background-color);
          white-space: normal;
          max-width: 100% !important;
        };
      }


    </style>

    <paper-card class="suttaplex" id="[[item.uid]]">
      <div class="card-content">

        <div class="suttaplex-head-container">
          <h3 class="suttaplex-heading">[[_computeMainHeading(item)]]</h3>
          <div class$="difficulty-icon">
            <iron-icon id="difficulty_icon" class="primary-accent-icon"
                       icon="[[_computeDifficultyLevelName(item.difficulty, 'sc-svg-icons:')]]"></iron-icon>
          </div>
          <paper-tooltip for="difficulty_icon" offset="0" fit-to-visible-bounds class="sc-tooltip">
            Recommended for [[_computeDifficultyLevelName(item.difficulty, '')]] students
          </paper-tooltip>
        </div>

        <div class="suttaplex-nerdy-row">
          <span title="Original title" class$="[[_computeHideOriginalTitle(item)]] nerdy-row-element">
            [[item.original_title]]
          </span>
          <span title="SuttaCentral ID" class$="[[_computeHideUID(item)]] nerdy-row-element">[[_getAcronymOrUid(item)]]
          </span>
          <template is="dom-if" if="[[item.volpages]]">
            <template is="dom-if" if=[[!item.biblio]]>
              <span class="book no-margin">
                <iron-icon class="grey-icon" icon="book"></iron-icon>
              </span>
              <span class="vol-page nerdy-row-element" title="Volume and page">[[item.volpages]]</span>
            </template>
            <template is="dom-if" if=[[item.biblio]]>
              <div>
                <details class="suttaplex-details display-inline">
                  <summary class="volpage-biblio-info-summary">
                    <span class="book no-margin">
                      <iron-icon class="grey-icon" icon="book"></iron-icon>
                    </span>
                    <span class="vol-page nerdy-row-element" title="Volume and page">[[item.volpages]]</span>
                  </summary>
                  <p class="volpage-biblio-info" inner-h-t-m-l="[[item.biblio]]"></p>
                </details>
              </div>
            </template>
          </template>
        </div>

        <p class$="suttaplex-description [[_computeHide(item.blurb)]]" title="Description"
           inner-h-t-m-l="[[item.blurb]]"></p>
      </div>

      <div class$="{{_addPaddingIfNoBlurb(item.blurb)}} card-actions">
        <div class="card-actions-left">
          <template is="dom-repeat" items="[[item.translations]]" as="translation">
            <template is="dom-if" if="{{_isChosenLang(translation.lang)}}">
              <paper-button class="author-button" flat
                            title$="Go to a translation by [[_capitalize(translation.author)]]">
                <a href="[[_getSuttaTextUrl(item.uid, translation.lang, translation.author)]]">
                  [[translation.author]]
                </a>
              </paper-button>
            </template>
          </template>
        </div>
        <div class="flex-div">
          <div class="languagedrop">
            <language-menu language-choice="[[item.translations]]" title-label="More"
                           input-language="[[inputLanguage]]" original-language="[[item.root_lang]]"
                           root-id="[[item.uid]]" on-paper-dropdown-close="_changeItemZIndex"
                           on-paper-dropdown-open="_changeItemZIndex" class="no-left-padding"></language-menu>
          </div>

          <div class="right-elements">
            <div class="vert-menu">
              <paper-menu-button id="copy_menu" horizontal-align="right" role="group" aria-haspopup="true"
                                 vertical-align="top" aria-disabled="false">
                <paper-icon-button class="more-info grey-icon" slot="dropdown-trigger" icon="icons:more-vert"
                                   role="button" tabindex="0" aria-disabled="false"></paper-icon-button>
                <paper-listbox class="more-par-listbox" slot="dropdown-content" tabindex="0" role="listbox">
                  <more-par-menu id="more_par_menu" tabindex="0" item="[[item]]">
                  </more-par-menu>
                </paper-listbox>
              </paper-menu-button>
            </div>

            <template is="dom-if" if="[[item.parallel_count]]">
              <div class="parallels-toggle-div">
                <paper-icon-button id="parallels_toggle" class="toggle-button grey-icon" icon="[[toggleIcon]]"
                                   on-tap="_toggleParallelsOpened">
                </paper-icon-button>
                <sc-badge class="absolute-pos behind-button" number="[[item.parallel_count]]"></sc-badge>
              </div>
              <paper-tooltip for="parallels_toggle" offset="-1" fit-to-visible-bounds class="sc-tooltip">This&nbsp;text&nbsp;has&nbsp;[[item.parallel_count]]&nbsp;parallels</paper-tooltip>
            </template>
          </div>
        </div>
      </div>

      <template is="dom-if" if="[[parallelsOpened]]">
        <iron-collapse id="collapse" opened="[[parallelsOpened]]">
          <sc-view-parallels root-lang="[[item.root_lang]]" item-uid="[[item.uid]]"
                             root-text="[[_getRootText(item.*)]]">
          </sc-view-parallels>
        </iron-collapse>
      </template>

    </paper-card>
  </template>

  <script>
      class SCSuttaplex extends Polymer.Element {
          static get is() {
              return 'sc-suttaplex';
          }

          static get properties() {
              return {
                  toggleIcon: {
                      type: String,
                      computed: '_computeToggleIcon(parallelsOpened)'
                  },
                  parallelsOpened: {
                      type: Boolean,
                      value: false,
                      observer: '_parallelsOpenedChanged'
                  },
                  opened: {
                      type: Boolean,
                      reflectToAttribute: true,
                      notify: true
                  },
                  _toggleIcon: {
                      type: String,
                      computed: '_computeToggleIcon(opened)'
                  },
                  _toggleMoreIcon: {
                      type: String,
                      computed: '_computeToggleMoreIcon(opened)'
                  },
                  inputLanguage: {
                      type: String,
                      value: 'en' // Temporary hardcoded
                  },
                  level: String,
                  // The suttaplex item
                  item: {
                      type: Object
                  },
                  toastMessage: {
                      type: String
                  }
              }
          }

          ready() {
              super.ready();
              this.addEventListener('par-menu-copied', (e) => {
                  this.$.copy_menu.opened = false;  // Close dropdown after the copy action.
              });

              this.$.copy_menu.addEventListener('opened-changed', (e) => {
                  const open = e.detail.value;
                  if (open) {
                      this.$.more_par_menu._sendRequest();
                  }
                  const type = open ? 'open' : 'close';
                  const event_mock = { type: type };
                  this._changeItemZIndex(event_mock);
              })
          }

          _changeItemZIndex(e) {
              let node = this.parentNode;
              if (node.style === undefined) {
                  return;
              }
              if (e.type.endsWith('open')) {
                  node.style['z-index'] = 100;
              } else if (node.style['z-index'] === '100') {
                  node.style['z-index'] = 0;
              }
          }

          _parallelsOpenedChanged(e) {
              const type = e ? 'open' : 'close';
              const event_mock = { type: type };
              this._changeItemZIndex(event_mock);
          }

          _shouldPullRight(parallelsOpened) {
              return parallelsOpened ? 'pull-right' : '';
          }

          // general function to hide or display various elements.
          _computeHide(checkText) {
              return (!checkText) ? 'hide-element' : '';
          }

          _computeHideUID(item) {
              return (item.translated_title || item.original_title) ? '' : 'hide-element'
          }

          _computeHideOriginalTitle(item) {
              return item.translated_title ? '' : 'hide-element'
          }

          // returns the relevant icon for the expander
          _computeToggleIcon(parallelsOpened) {
              return parallelsOpened ? 'icons:expand-less' : 'icons:expand-more';
          }

          // shows the more-par menu when the expander is opened.
          _computeToggleMoreIcon(opened) {
              return opened ? '' : 'moremenu';
          }

          // adds the 'tree'-icons to denote difficulty level if any.
          _computeDifficultyLevelName(level, namespace) {
              if (!level) return;
              if (level.name) {
                  return `${namespace}${level.name}`;
              }
              else {
                  const levels = { 1: 'beginner', 2: 'intermediate', 3: 'advanced' };
                  return `${namespace}${levels[level]}`;
              }
          }

          // Computes API endpoint URL for given translation
          _getSuttaTextUrl(uid, lang, author) {
              const url = window.location;
              const baseUrl = url.protocol + '//' + url.host;
              return `${baseUrl}/${uid}/${lang}/${author}`;
          }

          _isChosenLang(lang) {
              return lang === this.inputLanguage;
          }

          _toggleParallelsOpened() {
              this.parallelsOpened = !this.parallelsOpened;
              this.dispatchEvent(new CustomEvent('iron-resize', { composed: true, bubbles: true }));
          }

          _computeMainHeading(item) {
              if (!item) {
                  return '';
              }
              if (item.translated_title) {
                  return item.translated_title;
              } else if (item.original_title) {
                  return item.original_title;
              } else {
                  return item.acronym || item.uid;
              }
          }

          _addPaddingIfNoBlurb(blurb) {
              return (blurb === null || blurb === undefined) ? 'top-space' : '';
          }

          _capitalize(author) {
              return author.replace(/\b\w/g, l => l.toUpperCase());
          }

          _getAcronymOrUid(item) {
              return item.acronym || item.uid;
          }

          _getRootText() {
              return this.item.translations.find(translation => translation.lang === this.item.root_lang);
          }
      }

      customElements.define(SCSuttaplex.is, SCSuttaplex);
  </script>
</dom-module>
