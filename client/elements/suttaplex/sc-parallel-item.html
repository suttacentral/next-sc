<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../../elements/menus/language-menu.html">
<link rel="import" href="../../elements/addons/sc-sutta-note.html">

<!--
This element loads additional info for each relevant parallel sutta, which is then used in sc-view-parallels.html.
It is in effect a miniature version of the suttaplex-card
-->
<dom-module id="sc-parallel-item">
  <template>
    <style include="sc-suttaplex-styles" attributes="partitle volumepage biblio">
      :host {
        --language-menu-dropdown-width: 150px;
      }

      .parallel-item-main-info-container {
        width: 100%;
        max-width: 320px;
      }

      .parallel-item-title {
        @apply --paper-font-subhead;
        @apply --sc-serif-font;
        word-wrap: normal;
      }

      .parallel-item-biblio-info {
        @apply --paper-font-body1;
        @apply --shadow-elevation-3dp;
        border-top: var(--sc-border);
        position: absolute;
        z-index: 200;
        background-color: #fff;
        padding: 12px;
        margin: 0 var(--sc-size-xl) 0 0;
        white-space: normal;
      }

      .parallel-item-biblio-summary::-webkit-details-marker {
        color: var(--sc-disabled-text-color);
      }

      .parallel-item-details {
        @apply --paper-font-body2;
        color: var(--sc-secondary-text-color);
        white-space: normal;
        word-wrap: break-word;
        flex-wrap: wrap;
      }

      .parallel-item-details div:not(:last-child) {
        margin-right: 12px;
      }

      .parallel-item-language-dropdown {
        display: flex;
        justify-content: center;
        vertical-align: middle;
        margin-top: -16px;
      }

      .d-block {
        display: inline-block;
      }

      .scrollable-dialog {
        margin: 0;
      }

      .vertical-margin-xs {
        margin-top: var(--sc-size-xs);
        margin-bottom: var(--sc-size-xs);
      }

      .right-margin-md {
        margin-right: var(--sc-size-md);
      }

      .uppercase {
        text-transform: uppercase;
      }

      .d-flex {
        display: flex;
      }

      .flex-1 {
        flex: 1;
      }

      .justify-content-space-between {
        justify-content: space-between;
      }

      .align-items-center {
        align-items: center;
      }

      #remark_info {
        cursor: help;
      }

      .parallel-item-volpages-container {
        display: flex;
      }

      .no-padding {
        padding: 0;
      }

    </style>

    <div class="parallel-item d-flex justify-content-space-between" style="flex-wrap: wrap">

      <div class="parallel-item-main-info-container">
        <div class="parallel-item-title vertical-margin-xs">[[_computeTitle()]]</div>

        <div class="parallel-item-details d-flex align-items-center vertical-margin-xs">
          <template is="dom-if" if="[[_getAcronymOrId(parallelItem)]]">
            <div class$="parallel-item-id [[_computeRootIdVisibility()]]">
              <div title="SuttaCentral ID">[[_getAcronymOrId(parallelItem)]]</div>
            </div>
          </template>

          <div class="parallel-item-volpages-container">
            <template is="dom-if" if="[[_volpagesAvailable()]]">
              <div>
                <template is="dom-if" if="[[parallelItem.bib]]">
                  <details class="d-block">
                    <summary class="parallel-item-biblio-summary">
                      <span class="book scrollable-dialog">
                        <iron-icon icon="book"></iron-icon>
                      </span>
                      <span class="vol-page" title="Volume and page number">[[parallelItem.volpages]]</span>
                    </summary>
                    <p class="parallel-item-biblio-info" inner-h-t-m-l="[[parallelItem.bib]]"></p>
                  </details>
                </template>
                <template is="dom-if" if="[[!parallelItem.bib]]">
                  <span class="book scrollable-dialog" title="Volume and page number">
                    <iron-icon icon="book"></iron-icon>
                  </span>
                  <span class="vol-page" title="Volume and page number">[[parallelItem.volpages]]</span>
                </template>
              </div>
            </template>
            <template is="dom-if" if="[[remark]]">
              <div class="sutta-remark">
                <sc-sutta-note note-data="[[remark]]"></sc-sutta-note>
              </div>
            </template>
          </div>

          <div class="parallel-item-note">
            <template is="dom-if" if="[[parallelItem.note]]">
              <sc-sutta-note note-data="[[parallelItem.note]]"></sc-sutta-note>
            </template>
          </div>
        </div>
      </div>

      <template is="dom-if" if="[[_shouldShowLanguageDropdown()]]">
        <div class="parallel-item-language-dropdown d-flex align-items-center flex-1">
          <language-menu language-choice="[[parallelItem.translations]]"
                         title-label="[[_computeLanguageDropdownTitle()]]"
                         original-language="[[parallelItem.root_lang]]"
                         input-language=""
                         root-id="[[_computeParallelUrl()]]"
                         class="no-padding"
                         to="[[parallelItem.to]]"></language-menu>
        </div>
      </template>

    </div>
  </template>

  <script>
      class SCParallelItem extends Polymer.Element {
          static get is() {
              return 'sc-parallel-item';
          }

          static get properties() {
              return {
                  // The parallel item to be displayed
                  parallelItem: {
                      type: Object
                  },
                  remark: {
                      type: String
                  },
                  rootLangMappings: {
                      type: Object,
                      value: {
                          'pli': 'Pali',
                          'lzh': 'Chinese',
                          'san': 'Sanskrit',
                          'xct': 'Tibetan',
                          'pra': 'Prakrit',
                          'pgd': 'Gandhari',
                          'uig': 'Uighur',
                          'xto': 'TocharianA',
                          'kho': 'Khotanese'
                      }
                  }
              }
          }

          // returns the relevant header, either the title in the translated language,
          // otherwise in pali or otherwise just the ID.
          _computeTitle() {
              if (this.parallelItem.original_title) {
                  return this.parallelItem.original_title;
              } else {
                  return this.parallelItem.acronym ? this.parallelItem.acronym : this.parallelItem.uid;
              }
          }

          _computeRootIdVisibility() {
              return this.parallelItem.original_title ? '' : 'd-none';
          }

          // returns the URL for the parallel with the given index
          _computeParallelUrl() {
              return `${this.parallelItem.uid}`;
          }

          _volpagesAvailable() {
              return !!this.parallelItem.volpages;
          }

          _computeFullLangName(isoCode) {
              return this.rootLangMappings[isoCode];
          }

          _computeLanguageDropdownTitle() {
              if (this.parallelItem.root_lang) {
                  return this._computeFullLangName(this.parallelItem.root_lang);
              }
              else {
                  return 'Translations';
              }
          }

          _shouldShowLanguageDropdown() {
              return this.parallelItem.translations.length > 0;
          }

          _getAcronymOrId(item) {
              if (this._computeTitle() === this.parallelItem.uid) {
                  return item.acronym ? item.acronym : item.uid;
              } else return '';
          }
      }

      customElements.define(SCParallelItem.is, SCParallelItem);
  </script>
</dom-module>
