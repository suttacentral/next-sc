<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../menus/language-menu.html">
<link rel="import" href="../addons/sc-sutta-note.html">
<link rel="import" href="../../styles/sc-styles.html">
<link rel="import" href="../../styles/sc-suttaplex-styles.html">

<!--
This element loads additional info for each relevant parallel sutta, which is loaded from `../data/suttas`
and then used in sc-view-parallels.html . It is in effect a minature version of the suttaplex-card
-->
<dom-module id="sc-parallel-item">
  <template>
    <style include="sc-suttaplex-styles" attributes="partitle volumepage biblio">
      .parallel-item-title {
        @apply --paper-font-subhead;
        @apply --sc-serif-font;
      }

      .parallel-item-nerdy-row {
        @apply --paper-font-body2;
        color: var(--secondary-text-color);
        white-space: nowrap;
      }

      .parallel-item-biblio-info {
        @apply --paper-font-body1;
        position: absolute;
        z-index: 200;
        background-color: #fff;
        @apply --shadow-elevation-3dp;
        padding: 12px;
        border-top: 1px solid rgba(0, 0, 0, 0.12);
        margin: 0 48px 0 0;
        white-space: normal;
      }

      .parallel-item-biblio-summary::-webkit-details-marker {
        color: var(--paper-grey-300);
      }

      .parallel-item-details {
        @apply --paper-font-body2;
        color: var(--secondary-text-color);
        white-space: nowrap;
      }

      .parallel-item-language-dropdown-container {
        min-width: 30%;
      }

      .parallel-item-language-dropdown {
        display: inline-block;
        vertical-align: middle;
        margin: -16px 4px 0;
      }

      .d-block {
        display: inline-block;
      }

      .d-none {
        display: none;
      }

      .margin-top-md {
        margin-top: 8px;
      }

      .margin-right-lg {
        margin-right: 24px;
      }

      .no-margin {
        margin: 0;
      }

      .uppercase {
        text-transform: uppercase;
      }

      .justify-content-space-between {
        display: flex;
        justify-content: space-between;
      }
    </style>

    <div class="parallel-item">

      <div class="parallel-item-main-info-container">
        <div class="parallel-item-title">[[_computeTitle()]]</div>
        <div class="parallel-item-details justify-content-space-between">
          <span class="uppercase" title="SuttaCentral ID">[[parallelItem.uid]]</span>

          <div class="parallel-item-volpages-container">
            <template is="dom-if" if="[[_volpagesAvailable()]]">
              <div>
                <template is="dom-if" if="{{parallelItem.bib}}">
                  <details class="d-block">
                    <summary class="parallel-item-biblio-summary">
                      <span class="book no-margin">
                        <iron-icon icon="book"></iron-icon>
                      </span>
                      <span class="vol-page" title="Volume and page number">[[_getFirstVolpage()]]</span>
                    </summary>
                    <p class="parallel-item-biblio-info" inner-h-t-m-l="[[parallelItem.bib]]"></p>
                  </details>
                </template>
                <template is="dom-if" if="{{!parallelItem.bib}}">
                  <span class="book no-margin">
                    <iron-icon icon="book"></iron-icon>
                  </span>
                  <span class="vol-page" title="Volume and page number">[[_getFirstVolpage()]]</span>
                </template>
              </div>
            </template>
          </div>

        </div>
        <sc-sutta-note note-data="[[parallelItem.note]]" class$="[[_computeHide(parallelItem.note)]]"></sc-sutta-note>
      </div>

      <div class="parallel-item-language-dropdown-container">

      </div>

    </div>


    <div class="parallel-item-language-dropdown">
      <language-menu language-choice="[[_combineRootWithTranslations()]]" title-label="Translations" input-language=""
                     original-language="" input-url="[[_getItemUrl()]]"></language-menu>
    </div>

  </template>

  <script>
    class SCParallelItem extends Polymer.Element {
      static get is() {
        return 'sc-parallel-item';
      }

      static get properties() {
        return {
          // The parallel item to be displayed
          parallelItem: Object,
          rootLangMappings: {
            type: Object,
            value: {
              'pi': 'Pali',
              'lzh': 'Chinese',
              'skt': 'Sanskrit',
              'bo': 'Tibetan'
            }
          }
        }
      }

      // returns the relevant header, either the title in the translated language,
      // otherwise in pali or otherwise just the ID.
      _computeTitle() {
        if (this.parallelItem.original_title) {
          return this.parallelItem.original_title;
        }
        else return this.parallelItem.uid;
      }

      // returns the URL for the parallel with the given index
      _computeParallelUrl() {
        return `suttas/${this.parallelItem.to.uid}`;
      }

      _getFirstVolpage() {
        return this.parallelItem.volpages[0];
      }

      // general function to hide or display various elements.
      _computeHide(visible) {
        return visible ? '' : 'd-none';
      }


      // If the root lang is known, push it at the beginning of the translations array
      _combineRootWithTranslations() {
        if (this.parallelItem.root_lang) {
          const rootItem = {
            author: this._computeFullLangName(this.parallelItem.root_lang),
            id: this.parallelItem.uid,
            lang: this.parallelItem.root_lang,
            isRoot: true
          };
          this.parallelItem.translations.unshift(rootItem);
        }
        return this.parallelItem.translations;
      }

      _translationsAvailable() {
        return this.parallelItem.translations.length > 0;
      }

      _volpagesAvailable() {
        return this.parallelItem.volpages.length > 0;
      }

      _computeFullLangName(isoCode) {
        return this.rootLangMappings[isoCode];
      }
    }

    customElements.define(SCParallelItem.is, SCParallelItem);
  </script>
</dom-module>