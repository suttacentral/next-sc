<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-localize-behavior/app-localize-behavior.html">

<!--
  Functions for UID-expansion used in the suttaplex and parallel-lists.
-->
<dom-module id="sc-suttaplex-functions">
  <template>
  </template>

  <script>
      /**
       * @extends {Polymer.Element}
       * @appliesMixin Polymer.AppLocalizeBehavior
       */
      class SCSuttaplexFunctions extends Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior], ReduxMixin(Polymer.Element)) {

          static get properties() {
              return {
                  // The suttaplex item
                  item: {
                      type: Object
                  },
                  language: {
                      type: String,
                      statePath: 'siteLanguage',
                      observer: '_siteLanguageChanged'
                  },
                  fallbackLanguage: {
                      type: String,
                      value: 'en'
                  },
                  expansionData: {
                      type: Array
                  }
              }
          }

          connectedCallback() {
              super.connectedCallback();
          }

          _getAcronymOrUid(item, expansionData) {
              let scAcronym = '';
              if (item.acronym) {
                  scAcronym = item.acronym.split('//')[0];
              } else {
                  scAcronym = this._transformId(item.uid, expansionData);
              }
              return scAcronym;
          }

          // This function parses the input uid of the parallel
          // It is then split into it's various elements which are then expanded
          // according to the data in the expansion-table. 
          // So f.i. 'an3.4' becomes 'AN 3.4' and 'lzh-sarv-bi-vb-np1' becomes
          // 'Lzh Sarv Bi Vb NP 1'
          _transformId(rootId, expansionData) {
              if (!rootId || !expansionData) {
                  return '';
              }
              let scAcronym = '';
              const rootPart = rootId.split('#')[0];
              const uidParts = rootPart.split('-');
              let tail = '';
              try {
                  uidParts.forEach(item => {
                      if (!expansionData[0][item]) {
                          const tailMatch = item.match(/\d+.*/g);
                          if (tailMatch) tail = tailMatch[0] + '–';
                          const itemMatch = item.match(/[a-z]*/g);
                          if (itemMatch) item = itemMatch[0];
                      }
                      if (item && expansionData[0][item]) {
                          scAcronym += `${expansionData[0][item][0]} ${tail}`
                      } else {
                          scAcronym += tail;
                      }
                  });
                  return scAcronym.replace(/–\s*$/, '');
              } catch (e) {
                  console.error(e);
              }
          }

          _getParagraphRange(rootId) {
              const ids = rootId.split(/#(.*)/)[1];
              if (!ids) {
                  return '';
              }
              if (ids.includes('-')) {
                  const [id1, id2] = ids.split('-#');
                  return `#${id1}–${id2}`;
              }
              return `#${ids}`;
          }

          _getAcronymOrUid(item, expansionData) {
              let scAcronym = '';
              if (item.acronym) {
                  scAcronym = item.acronym.split('//')[0];
                  const rootId = item.to.replace('~', '');
                  const idPart = this._getParagraphRange(rootId).replace('-', '–');
                  return `${scAcronym}${idPart}`;
              } else {
                  scAcronym = this._transformId(item.to, expansionData, 0);
              }
              return scAcronym;
          }

          // This function parses the input uid of the parallel and splits it into
          // it's main document part (rootPart) and the id (paragraphs) within the document (idPart)
          // The rootPart is then split into it's various elements which are then expanded
          // according to the data in the expansion-table. 
          // So f.i. 'an3.4#23-#25' becomes 'AN 3.4 #23-25' and 'lzh-sarv-bi-vb-np1' becomes
          // 'Lzh Sarv Bi Vb NP 1'
          _transformId(rootId, expansionData, idOrName) {
              if (!rootId || !expansionData) {
                  return '';
              }
              rootId = rootId.replace('~', '');
              const idPart = this._getParagraphRange(rootId).replace('-', '–');
              let scAcronym = '';
              const rootPart = rootId.split('#')[0];
              const uidParts = rootPart.split('-');
              let tail = '';
              uidParts.forEach(item => {
                  if (!expansionData[0][item]) {
                      const tailMatch = item.match(/\d+.*/g);
                      tailMatch ? tail = tailMatch[0] + '–' : tail;
                      const itemMatch = item.match(/[a-z]*/g);
                      itemMatch ? item = itemMatch[0] : item;
                  }
                  if (item && expansionData[0][item]) {
                      scAcronym += `${expansionData[0][item][idOrName]} ${tail}`
                  } else {
                      scAcronym += tail;
                  }
              });
              scAcronym = scAcronym.replace(/–\s*$/, '');
              return `${scAcronym}${idPart}`;
          }

          _getParagraphRange(rootId) {
              const ids = rootId.split(/#(.*)/)[1];
              if (!ids) {
                  return '';
              }
              if (ids.includes('-')) {
                  const [id1, id2] = ids.split('-#');
                  return `#${id1}--${id2}`;
              }
              return `#${ids}`;
          }


          // This function parses the input uid of the parallel and splits it into
          // it's main document part (root_part) and the id (paragraphs) within the document (id_part)
          // The root_part is then split into it's various elements which are then expanded
          // according to the data in the expansion-table. 
          // So f.i. 'an3.4#23-#25' becomes 'AN 3.4 #23-25' and 'lzh-sarv-bi-vb-np1' becomes
          // 'Lzh Sarv Bi Vb NP 1'
          _transformId(rootId, expansionData) {
              if (!rootId || !expansionData) {
                  return '';
              }
              const idPart = this._getParagraphRange(rootId).replace('--', '–');
              const rootPart = rootId.split('#')[0];
              const uidParts = rootPart.split('-');
              let scAcronym = '';
              let tail = '';
              uidParts.forEach(item => {
                  if (!expansionData[0][item]) {
                      let tailMatch = item.match(/\d+.*/g);
                      if (tailMatch) tail = tailMatch[0] + '–';
                      let itemMatch = item.match(/[a-z]*/g);
                      if (itemMatch) item = itemMatch[0];
                  }
                  if (item && expansionData[0][item]) {
                      scAcronym += `${expansionData[0][item][0]} ${tail}`
                  } else {
                      scAcronym += tail;
                  }
              });
              scAcronym = scAcronym.replace(/–\s*$/, '');
              return `${scAcronym}${idPart}`;
          }



      }

      customElements.define('sc-suttaplex-functions', SCSuttaplexFunctions);
  </script>
</dom-module>
