<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">

<link rel="import" href="addons/sc-node.html">
<link rel="import" href="suttaplex/sc-suttaplex.html">

<!--
This element displays a range of suttaplex cards or just one, depending on the route chosen.
It loads a (mockup) file from `../data/list`which lists the relevant Nikaya's name in pali,
in various translations and the descriptions in various translations. It also lists which vaggas are part of
this (with translated names and descriptions) and which suttas are part of which vagga.

The various translations in the json file are shown when another site-language is chosen.

For more info: https://discourse.suttacentral.net/t/suttaplex-list-pages/4762
When a range of suttaplex cards is displayed, it also displays the title and vaggas, etc. with some text
in an expander above.
This will need to be discussed further with Sujato with regards to the new structure he wants in the navigation-drawer.
For instance `/dn` would result in a list of all suttaplex-cards for the DN, sorted per vagga with relevant vagga
titles and explanatory texts in expanders, `/dn/vagga1` would result in a list of just the first vagga, while `/dn1`
would result in just one opened suttaplex-card for that specific sutta.

Issues that need to be fixed:
    - This system now works for the DN and MN but for more complex texts like the AN and SN it will not work yet.
    It is also not entirely clear to me how Sujato wants to do this. For instance, in the old system we had `/sn`
    and `/sn1` as lists but now Sujato would like it to be different and have something like `/sn`, `sn/vagga1`,
    `/sn/vagga1/samyutta1`, `/sn/vagga1/samyutta1/pannasa1`and `/sn/vagga1/samyutta1/pannasa1/vagga1`all as various
    possible list-choices with the relevant headers and explanatory texts (which do not yet exist but the system in
    this suttaplex element can work without that i.e. if no explanatory text exists, it simply does not display the
    expander either).
    So the would mean the `/sn1` no longer exists as a choice but for instance `/sn1.1` will show the one opened
    suttaplex-card for that specific sutta.
    - This element can now only distinguish between vaggas and individual suttas and defines the latter as anything
    with a number in it, so that is rather limited and will have to change once the new structure is clear.
    - I have been toying with the idea to merge the two lists i.e. the list imported here that is used for the
    suttaplex-view and the list that is imported for the paper-tree in the navigation-drawer. Both list overlapping
    information so that might be an idea.
    - Instead of a dom-repeat of the suttaplex-cards in the array, it might be better to use an iron-list because
    for some of these there are thousands of cards so it might become too slow otherwise.
-->
<dom-module id="sc-view-suttaplex" attributes="divisiontitle">
  <template>
    <style is="custom-style">
      .divisioncontent {
        color: var(--primary-text-color);
        padding: 24px 0;
      }

      main {
        margin: 0 auto;
        max-width: 720px;
      }

      .suttalist {
        margin: 0 auto;
        max-width: 720px;
        transition: margin-top 0.3s, margin-bottom 0.3s;
      }

      .title {
        margin-left: 64px;
      }

      .expandeditem {
        @apply --shadow-elevation-8dp;
        margin-top: 20px;
        margin-bottom: 20px;
      }

      .node {
        padding: 16px 16px 0;
        color: var(--secondary-text-color);
      }

      .vagganode {
        padding: 24px 16px 16px;
        color: var(--secondary-text-color);
      }

      .vagganode.firstvagga, .node + .vagganode {
        padding-top: 0;
      }

      paper-spinner-lite {
        --paper-spinner-color: var(--sc-gold-500);
        left: 50%;
        top: 50px;
      }

      .notfound {
        @apply --paper-font-display1;
      }
    </style>

    <iron-ajax id="ajax"
               url="[[_computeURL(category)]]"
               handle-as="json"
               loading="{{ loadingResults }}"
               last-response="{{ suttaList }}"
               last-error='{{ notFound }}'></iron-ajax>

    <div class="loadingIndicator">
      <paper-spinner-lite active="{{ loadingResults }}"></paper-spinner-lite>
    </div>
      <template is="dom-if" if="[[notFound]]">
        <p class="notfound">Sorry, the page your requested does not exist.</p>
      </template>

      <div class="divisioncontent">
        <main>

          <template is="dom-if" if="[[!notFound]]">
            <!-- Shows a list of suttaplex-cards with relavant headers depending on the chosen vagga or all vaggas. -->
            <template is="dom-if" if="[[_checkCategoryRoute(category)]]">
              
              <section class="node">
                <sc-node input-title="[[languageData.name]]" input-text="[[languageData.description]]"
                        style-header="node-top-heading"></sc-node>
              </section>

              <template is="dom-repeat" items="[[suttaList.vaggas]]" as="vagga">
                <template is="dom-if" if="[[_selectVagga(vagga,vaggaNumber)]]">
                  <section class$="vagganode [[_checkFirstVagga(vagga,vaggaNumber)]]">
                    <sc-node input-title="[[_computeVagganame(vagga,inputLanguage)]]"
                            input-text="[[_computeVaggadescription(vagga,inputLanguage)]]"
                            style-header="node-secondary-heading"></sc-node>
                  </section>

                  <template is="dom-repeat" items="[[vagga.suttas]]" as="item">
                    <div class="suttalist" id$="[[item]]">
                      <sc-suttaplex input-url="[[item]]"
                                    input-language="[[inputLanguage]]"></sc-suttaplex>
                    </div>
                  </template>
                </template>
              </template>
            </template>
          </template>

          <!-- Shows an open suttaplex-card if only one sutta is requested but without specifying an author (i.e. routes like '/dn1') -->
          <template is="dom-if" if="[[!_checkCategoryRoute(category)]]">
            <template is="dom-if" if="[[!activePath]]">
              <div class="suttalist" id="[[category]]">
                <sc-suttaplex input-url="[[category]]" toggle-request
                              input-language="[[inputLanguage]]"></sc-suttaplex>
              </div>
            </template>
          </template>

        </main>
    </div>
  </template>

  <script>
      class ViewSuttaplex extends Polymer.Element {
          static get is() {
            return 'sc-view-suttaplex'
          }

          static get properties() {
            return {
              inputLanguage: String,
              suttaList: {
                  type: Object,
                  notify: true,
              },
              activePath: Boolean,

              // Object with relevant language data in the loaded data depending on the chosen site language.
              languageData: {
                  type: Object,
                  computed: '_computeLanguage(suttaList,inputLanguage)'
              },

              // if route contains a vagga, the relevant number is passed.
              vaggaNumber: {
                  type: String,
                  value: ""
              },

              // route information
              category: {
                  type: String,
                  notify: true,
                  observer: '_callAjax'
              },

              // array of pages that are not suttaplex or suttas.
              otherPages: {
                  type: Array,
                  value: ["dons", "people", "downloads", "", "search", "define"]
              }
            }
          }
          static get observers() {
            return [
              'infoToParent(suttaList,inputLanguage)'
          ]
          }
          // event listener that gets information from the suttaplex-card if it is opened.
          ready() {
              super.ready()
              this.addEventListener('toggleParallelNote', this.elevateBox);
          }
          // Right now this checks if the route url has a number and if so, concludes that this must be a sutta and
          // not a division so it wants to display only the suttaplex card for that sutta. This is not correct and needs
          // better criteria to decide if something is a sutta or a list of various suttas.
          _checkCategoryRoute(category) {
              let matches;
              if (category) {
                  matches = category.match(/\d{1,6}/);
              }
              return (!matches);
          }

          // Same as above, it checks if the route url has a number and if so concludes it must be a sutta. This will
          // need to change and have better criteria for checking if something is a sutta or a list.
          _callAjax() {
              let matches;
              if (this.category) {
                  matches = this.category.match(/\d{1,6}/);
              }
              return (!matches && (this.otherPages.indexOf(this.category) === -1)) ? this.$.ajax.generateRequest() : "";
          }
          // when a suttaplex card is opened, this one is lifted out of the list and given a new class.
          elevateBox(event) {
              const sutta = this.$$('#' + event.detail.url);
              return (event.detail.open === "icons:expand-more") ? sutta.classList.add('expandeditem') : sutta.classList.remove('expandeditem');
          }
          // returns url for the suttaplex data
          _computeURL(category) {
              console.log(`api/suttaplex/${category}`);
              return `api/suttaplex/${category}`;
          }
          // returns true if there either is no vaggaNumber (i.e. all vaggas are to be shown) or
          // if the vaggaNumber is equal to the vagganumber that is current in the dom-repeat (i.e. THIS vagga is to be shown).
          _selectVagga(vagga, vaggaNumber) {
              return (!vaggaNumber || vaggaNumber === vagga.vagganr);
          }
          // returns relevant classname if the vagga is the first one to be displayed (different spacing to the top from other vaggas)
          _checkFirstVagga(vagga, vaggaNumber) {
              return vaggaNumber ? ((vaggaNumber === vagga.vagganr) ? "firstvagga" : "") : "";
          }
          // returns the relevant language data in the loaded data depending on the chosen site language.
          _computeLanguage(suttaList, inputLanguage) {
              return suttaList ? suttaList[inputLanguage] : "";
          }
          // returns the relevant vagganame in the chosen site language.
          _computeVagganame(vagga, inputLanguage) {
              return vagga[inputLanguage].vagganame;
          }
          // returns the relevant vagga text description in the chosen site language.
          _computeVaggadescription(vagga, inputLanguage) {
              return vagga[inputLanguage].description;
          }
          // When the datafile has been fully loaded, fires the relevant data for toolbar-title back to page-selector.
          infoToParent(suttaList, inputLanguage) {
              if (suttaList) {
                  this.fire('eventFromSuttaplexPage', {
                      divisiontitle: this._computeLanguage(suttaList, inputLanguage)['name'] + "—" + suttaList['namepi']
                  });
              }
          }
      }

  </script>
</dom-module>

