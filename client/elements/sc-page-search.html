<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-location/iron-location.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="menus/search-menu.html">

<!--
The search page opens when a search string is typed into the search-input-box in the toolbar.

The loading is done within an iron-scroll-threshold in case there are very large numbers of results.

If the results are in more than one category of root texts, translations, and dictionaries, and there are more
than ten results in total, a dropdown selection menu appears at the top.
-->
<dom-module id="sc-page-search">
  <template>
    <style is="custom-style">
      .divisioncontent {
        @apply --sc-sans-font;
        padding: 72px 0;
      }

      main {
        max-width: 720px;
        margin: 0 auto;
      }

      .results-head {
        display: flex;
        justify-content: space-between;
        padding: 0 16px;
        color: var(--secondary-text-color);
      }

      h1 {
        @apply --paper-font-display1;
        display: inline-block;
        margin: 0;
      }

      .result-term {
        font-weight: bold;
        color: var(--sc-green-600);
        @apply --sc-serif-font;
      }

      iron-list {
        padding: 28px 0 16px;
      }

      .item {
        @apply --layout-horizontal;
        border-bottom: 1px solid var(--paper-grey-300);
      }

      .item:focus {
        outline: 0;
        background: linear-gradient(to right, rgba(67, 160, 7, 1) 4px, rgba(67, 160, 7, 0) 4px);
      }

      .pad {
        padding: 0 16px;
        @apply --layout-flex;
        @apply --layout-vertical;
      }

      h2 {
        @apply --paper-font-headline;
        color: var(--sc-green-600);
        margin: 22px 0 0 0;
      }

      .results-url {
        @apply --paper-font-body2;
        color: var(--secondary-text-color);
        white-space: nowrap;
        margin: 0 0 16px;
        overflow: hidden;
      }

      .snippet {
        @apply --sc-paper-font-body;
        margin: 0 0 20px 0;
      }

      search-menu {
        margin-top: -20px;
      }

      .nodisplay {
        display: none;
      }

      paper-spinner-lite {
        --paper-spinner-color: var(--sc-gold-500);
        left: 50%;
        top: 50px;
      }

      a {
        text-decoration: none;
        color: initial;
      }

      .google-maps {
        height: 480px;
        margin-bottom: 20px;
      }

      .google-maps iframe {
        height: 480px;
        width: 100%;
        border: none;
      }
    </style>

    <iron-ajax id="ajax"
               url="api/search"
               params='[[searchParams]]'
               handle-as="json"
               loading="{{loadingResults}}"
               last-response="{{responseData}}"
               on-response="_didRespond"></iron-ajax>

    <div class="loadingIndicator">
      <paper-spinner-lite active="{{loadingResults}}"></paper-spinner-lite>
    </div>

    <div class="divisioncontent">
      <main>
        <div class="results-head">
          <h1>
            <span class="result-number">[[_calculateNumber(responseData)]]</span>
            <span class="result-description">results for</span>
            <span class="result-term">[[searchQuery]]</span>
          </h1>
          <search-menu id="filter_menu"></search-menu>
        </div>

        <iron-scroll-threshold id="scroll_threshold" lower-threshold="0" on-lower-threshold="_loadMoreData"
                               scroll-target="document">

          <iron-list id="search_result_list" items="[[visibleSearchResults]]" as="item" scroll-target="document">
            <template>
              <div class="item" tabindex$="[[tabIndex]]">
                <div class="pad">
                  <a href="[[_calculateLink(item)]]">
                    <div class="primary">
                      <h2>[[item._source.heading.title]]</h2>
                    </div>
                    <div class="secondary">
                      <p class="results-url" inner-h-t-m-l="[[item._source.heading.division]]"></p>
                    </div>
                  </a>
                  <div class="secondary">
                    <p class="snippet" inner-h-t-m-l="[[item.highlight.content]]"></p>
                  </div>
                </div>
              </div>
            </template>
          </iron-list>

        </iron-scroll-threshold>

      </main>
    </div>
  </template>
  <script>
      class SCPageSearch extends Polymer.Element {
          static get is() {
              return 'sc-page-search'
          }

          static get properties() {
              return {
                  searchQuery: String,
                  responseData: Array,
                  lastSearchResults: {
                      type: Array,
                      notify: true,
                      value: []
                  },
                  allSearchResults: {
                      type: Array,
                      value: []
                  },
                  visibleSearchResults: {

                  },
                  resultCount: {
                      type: Number,
                      value: 0
                  },
                  // Number of items to be loaded each time the scroll threshold is reached
                  resultsPerLoad: {
                      type: Number,
                      value: 20
                  },
                  currentPage: {
                      type: Number,
                      value: 0
                  },
                  currentFilter: {
                      type: String,
                      value: 'all'
                  },
                  // Approximate height of one search result element, needed for endless scroll calculations.
                  // Default is 210 (typical desktop item height), but it's recalculated in _shouldLoadMoreData().
                  searchResultElemHeight: {
                      type: Number,
                      value: 210
                  }
              }
          }

          static get observers() {
              return ['_populateList(lastSearchResults, responseData)']
          }

          ready() {
              super.ready();
              this.searchListNode = this.shadowRoot.querySelector('#search_result_list');
              this.addEventListener('eventFromSearchMenu', this._calculateCurrentFilter);
              this.searchParams = {
                  limit: this.resultsPerLoad,
                  query: this.searchQuery
              };
              // Calls the input results when page is loaded
              this.shadowRoot.querySelector('#ajax').generateRequest();
          }

          // listens to the search-menu and changes the items to be displayed accordingly to "all", "root texts",
          // "translations" or "dictionaries"
          _calculateCurrentFilter(event) {
              let selectedView;
              switch (event.detail.searchView) {
                  case 1:
                      selectedView = "root-text";
                      break;
                  case 2:
                      selectedView = "translation";
                      break;
                  case 3:
                      selectedView = "dictionary";
                      break;
                  default:
                      selectedView = "all";
              }
              this.currentFilter = selectedView;
              this._filterItems();
          }

          // After results have been loaded into memory, pushes items to an array.
          // After first load, the lastSearchResults is equal to all the items in the
          // search results and _populateList is called.
          _didRespond(e) {
              const results = e.detail.response;
              this.set('lastSearchResults', results.hits.hits);
              this.set('resultCount', results.hits.total);
          }

          // Sets the visible items to elements that fit in the current filter
          _filterItems() {
              this.set('visibleSearchResults', this.allSearchResults.filter((item) => {
                  return this._calculateItemCategory(item) === this.currentFilter || this.currentFilter === 'all';
              }));
          }

          // The items to be displayed are added to the iron-list and counts the numbers in the list.
          _populateList() {
              if (this.lastSearchResults.length === 0) {
                  return;
              }
              for (let i = 0; i < this.lastSearchResults.length; i++) {
                  if (!this.lastSearchResults[i]) {
                      return;
                  }
                  this.push('allSearchResults', this.lastSearchResults[i]);
              }
              this._filterItems();
          }

          // Determines how the iron-scroll-threshold pushes the items to the iron-list
          // depending on the number of items to be loaded and on previously set parameters.
          _loadMoreData() {
              this.shadowRoot.querySelector('#scroll_threshold').clearTriggers();
              if (!this._shouldLoadMoreData()) {
                  return;
              }
              // Don't load once all items have been loaded.
              if (this.searchListNode.items.length >= this.resultCount) {
                  return;
              }
              this.currentPage++;
              this.searchParams = {
                  limit: this.resultsPerLoad,
                  offset: (this.currentPage * this.resultsPerLoad),
                  query: this.searchQuery
              };
              this.shadowRoot.querySelector('#ajax').generateRequest();
          }

          // Checks if the user scrolled past the required threshold to load more search results.
          // This has some relatively expensive DOM querying, but at the moment is necessary because of this bug:
          // https://github.com/PolymerElements/iron-list/issues/290.
          _shouldLoadMoreData() {
              if (!this.searchListNode) {
                  return;
              }
              if (this.searchListNode.children.item(1)) {
                  // update height of a single search result element (can differ by user device)
                  this.searchResultElemHeight = this.searchListNode.children.item(1).clientHeight;
                  console.log(this.searchResultElemHeight);
              }
              // the threshold is set to fire when 2 elements are still not in view.
              const scrollThreshold = this.currentPage * (this.resultsPerLoad - 2) * this.searchResultElemHeight;
              return document.body.scrollTop > scrollThreshold;
          }

          // If the number of results is less than 10 or there is only 1 category of results, the search filtering
          // menu is not displayed.
          _calculateFilterMenuVisibility() {
              const items = this.allSearchResults;
              if (items.length > 10) {
                  for (let i = 1; i < items.length; i++) {
                      if (this._calculateItemCategory(items[i]) !== this._calculateItemCategory(items[0])) {
                          return "";
                      }
                  }
              }
              return "nodisplay";
          }

          _calculateItemCategory(item) {
              // TODO add 'dictionary' category
              if (item._source.is_root) {
                  return "root-text"
              }
              else return "translation";
          }

          // Determines the number of search results that have been found.
          _calculateNumber(data) {
              return data ? data.hits.total : 0;
          }

          // if the item is a dictionary-item, the appropriate link is added, otherwise the url is used.
          _calculateLink(item) {
              return (item.category === "dictionary") ? ("/define/" + item._source.heading.title) : item.url;
          }

      }

      customElements.define(SCPageSearch.is, SCPageSearch);
  </script>
</dom-module>
