<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/iron-icons/editor-icons.html">
<link rel="import" href="/bower_components/iron-icons/social-icons.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/bower_components/neon-animation/web-animations.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">

<!--
Menu on top of the suttaplex parallel's list for copying information from parallels to clipboard.
-->
<dom-module id="more-par-menu">
  <template>
    <style is="custom-style">
      paper-item iron-icon {
        margin-right: 16px;
        color: var(--disabled-text-color);
      }

      .button-text {
        color: inherit;
      }

      .button-text:hover {
        cursor: pointer;
        background-color: var(--paper-grey-200);
      }

      .table-element {
        white-space: nowrap;
      }

      .table-element[disabled] {
        --iron-icon-fill-color: var(--paper-grey-200);
        color: var(--paper-grey-200);
      }
    </style>

    <iron-ajax id="parallels_ajax"
               auto
               url="[[_getAPIEndpoint(item)]]"
               handle-as="json"
               loading="{{ loadingParallels }}"
               last-response="{{ parallels }}"></iron-ajax>

    <paper-item class="table-element button-text" on-tap="_copyLink" title="[[itemLink]]">
      <iron-icon icon="link"></iron-icon>
      Copy link
    </paper-item>
    <paper-item class="table-element button-text" on-tap="_copyContent" disabled="{{ areParallelsAvailable }}">
      <iron-icon icon="content-copy"></iron-icon>
      Copy table
    </paper-item>
    <paper-item class="table-element button-text" on-tap="_copyCite" disabled="{{ areParallelsAvailable }}">
      <iron-icon icon="editor:format-quote"></iron-icon>
      Cite
    </paper-item>

  </template>

  <script>
      class SCMoreParMenu extends Polymer.Element {
          static get is() {
              return 'more-par-menu';
          }

          static get properties() {
              return {
                  item: {
                      type: Object,
                  },
                  inputData: {
                      type: Object,
                      notify: true
                  },
                  parallelsArray: {
                      type: Array,
                      notify: true
                  },
                  itemLink: {
                      type: Array,
                      computed: '_computeLink()'
                  },
                  parallels: {
                      type: Object
                  },
                  loadingParallels: {
                      type: Boolean,
                  },
                  areParallelsAvailable: {
                      type: Boolean,
                      value: false,
                      computed: "_setAreParallelsAvaiable(loadingParallels)"
                  }
              }
          }

          _notifyCopy(message, success) {
              this.dispatchEvent(new CustomEvent('par-menu-copied', {
                  detail: {message: message, success: success},
                  bubbles: true,
                  composed: true
              }))
          }

          // copy the parallels-table in html-string
          _copyContent() {
              try {
                  const copyTextarea = this._computeCopyTable();
                  this._copyToClipboard(copyTextarea);
                  this._notifyCopy('Parallels table copied!', true);
              } catch (err) {
                  this._notifyCopy('Error!', false);
                  console.error(err);
              }
          }

          _setAreParallelsAvaiable(loadingParallels) {
            return loadingParallels || (Object.keys(this.parallels).length === 0 && typeof this.parallels === 'object')
          }

          _computeLink() {
              const url = window.location;
              const baseUrl = url.protocol + '//' + url.host;
              return `${baseUrl}/${this.item.uid}`;
          }

          // Copy the link to the suttaplex page
          _copyLink() {
              try {
                  this._copyToClipboard(this.itemLink);
                  this._notifyCopy('Link copied!', true);
              } catch (err) {
                  this._notifyCopy('Error!', false);
                  console.error(err);
              }
          }

          //  copy cite-information about parallels and bibliography.
          _copyCite() {
              try {
                  const copyTextarea = this._computeCiteData(this.inputData, this.parallelsArray);
                  this._copyToClipboard(copyTextarea);
                  this._notifyCopy('Cite copied!', true);
              } catch (err) {
                  this._notifyCopy('Error!', false);
                  console.error(err);
              }
          }

          // copies inputtext to the clipboard by creating and selecting a dummy element.
          _copyToClipboard(inputText) {
              const textarea = document.createElement("textarea");
              textarea.textContent = inputText;
              textarea.style.position = "fixed";
              document.body.appendChild(textarea);
              textarea.select();
              try {
                  return document.execCommand("copy");
              } catch (err) {
                  console.error(err);
                  return false;
              } finally {
                  document.body.removeChild(textarea);
              }
          }

          _computeIconForType(type) {
              if (type === 'parallels') return 'swap-horiz';
              if (type === 'retells') return 'cached';
              if (type === 'mentions') return 'editor:format-quote';
              return '';
          }

          // icons to be used instead of iron icons in the base html-string copy function
          _computeIcon(parallel) {
              switch (this._computeIconForType(parallel.type)) {
                  case 'swap-horiz':
                      return '‚ÆÄ';
                  case 'compare-arrows':
                      return '‚âà';
                  case 'editor:format-quote':
                      return '‚ùû';
                  case 'cached':
                      return 'üîÉ';
              }
          }

          // creates a parallels-table in html-string
          _computeCopyTable() {
              const head = `<!DOCTYPE>\n<html>\n<head>\n  <title>${this.item.uid} ${this.item.original_title}</title>\n</head>\n`;
              let body = `<body>\n<table>\n  <caption>${this.item.original_title}</caption>\n`;
              for (let section of Object.keys(this.parallels)) {
                  let tbody = '<tbody>\n';
                  let size = this.parallels[section].length;
                  let first = true;
                  let tr = '';
                  for (let parallel of this.parallels[section]) {
                      tr = '  <tr>\n';
                      if (first) {
                          tr += `    <td rowspan=${size}>${section}</td>\n`;
                          first = false;
                      }
                      tr += `    <td>${this._computeIcon(parallel)}</td>\n`;
                      tr += `    <td>${parallel.to.to}</td>\n`;
                      tr += `    <td>${parallel.to.original_title}</td>\n`;
                      tbody += `${tr}  </tr>\n`;
                  }

                  body += `${tbody}</tbody>\n`;
              }
              body += '</table>\n</body>\n</html>';
              return head + body;
          }

          // creates cite data for parallels with parallels-list and bibliographical information
          _computeCiteData(inputData, parallelsArray) {
              if (inputData.parallels) {
                  citefinalplugin = "";
                  const d = new Date();
                  for (let x = 0; x < inputData.parallels.length; x++) {
                      const relationships = inputData.parallels[x].relations;
                      let citeplugin = "Parallels for " + inputData.parallels[x].id + " " + inputData.titlepi + " (" + inputData.volpage + "): ";
                      for (let i = 0; i < relationships.length; i++) {
                          citeplugin += relationships[i].id;
                          for (let parobject = 0; parobject < parallelsArray.length; parobject++) {
                              if (parallelsArray[parobject].parid === relationships[i].id) {
                                  if (parallelsArray[parobject].volumepage) {
                                      citeplugin += " (" + parallelsArray[parobject].volumepage + ") ";
                                  }
                                  if (parallelsArray[parobject].biblio) {
                                      citeplugin += parallelsArray[parobject].biblio;
                                  }
                              }
                          }
                          if (i < relationships.length - 1) {
                              citeplugin += "; ";
                          }
                      }
                      citefinalplugin += citeplugin + "\n";
                  }
                  return this.citeData = citefinalplugin + "Retrieved from https://suttacentral.net/" + inputData.url + " on " + d + ".";
              }
          }

          _getAPIEndpoint(item) {
              return `/api/parallels/${item.uid}`;
          }
      }

      customElements.define(SCMoreParMenu.is, SCMoreParMenu);
  </script>
</dom-module>
