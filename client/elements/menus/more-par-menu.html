<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/neon-animation/web-animations.html">

<!--
Menu on top of the suttaplex parallel's list for copying information from parallels to clipboard.
-->
<dom-module id="more-par-menu">
  <template>
    <style is="custom-style">
      paper-item iron-icon {
        margin-right: 16px;
        color: var(--disabled-text-color);
      }

      .button-text {
        color: inherit;
      }

      .button-text:hover {
          cursor: pointer;
          background-color: var(--paper-grey-200);
      }
    </style>

    <paper-item on-tap="_copyLink" class="button-text">
      <iron-icon icon="link"></iron-icon>
      Copy link
    </paper-item>
    <paper-item on-tap="_copyContent" class="button-text">
      <iron-icon icon="content-copy"></iron-icon>
      Copy table
    </paper-item>
    <paper-item on-tap="_copyCite" class="button-text">
      <iron-icon icon="editor:format-quote"></iron-icon>
      Cite
    </paper-item>
  </template>

  <script>
      class SCMoreParMenu extends Polymer.Element {
          static get is() {
              return 'more-par-menu';
          }

          static get properties() {
              return {
                  item: {
                      type: Object,
                  },
                  inputData: {
                      type: Object,
                      notify: true
                  },
                  parallelsArray: {
                      type: Array,
                      notify: true
                  }
              }
          }

          // copy the parallels-table in html-string
          _copyContent() {
              const copyTextarea = this._computeCopyTable(this.inputData, this.parallelsArray);
              this._copyToClipboard(copyTextarea);
          }

          // Copy the link to the suttaplex page
          _copyLink() {
            const getUrl = window.location;
            const baseUrl = getUrl .protocol + "//" + getUrl.host;
              this._copyToClipboard(baseUrl + '/sutta/' + this.item.uid);
          }

          //  copy cite-information about parallels and bibliography.
          _copyCite() {
              const copyTextarea = this._computeCiteData(this.inputData, this.parallelsArray);
              this._copyToClipboard(copyTextarea);
          }

          // copies inputtext to the clipboard by creating and selecting a dummy element.
          _copyToClipboard(inputText) {
              const textarea = document.createElement("textarea");
              textarea.textContent = inputText;
              textarea.style.position = "fixed";
              document.body.appendChild(textarea);
              textarea.select();
              try {
                  return document.execCommand("copy");
              } catch (err) {
                  console.error(err);
                  return false;
              } finally {
                  document.body.removeChild(textarea);
              }
          }

          // icons to be used instead of iron icons in the base html-string copy function
          _computeIcon(icon) {
              switch (icon) {
                  case 'swap-horiz':
                      return '‚ÆÄ';
                  case 'compare-arrows':
                      return '‚âà';
                  case 'editor:format-quote':
                      return '‚ùû';
                  case 'cached':
                      return 'üîÉ';
              }
          }

          // creates a parallels-table in html-string
          _computeCopyTable(inputData, parallelsArray) {
              let titlepi = "";
              if (inputData.parallels) {
                  tablefinalplugin = "";
                  for (let x = 0; x < inputData.parallels.length; x++) {
                      const relationships = inputData.parallels[x].relations;
                      let tableplugin = "\n<tbody>\n  <tr>\n    <td rowspan='" + relationships.length + "'>" + inputData.parallels[x].id + "</td>";
                      for (let i = 0; i < relationships.length; i++) {
                          for (let parobject = 0; parobject < parallelsArray.length; parobject++) {
                              if (parallelsArray[parobject].parid === relationships[i].id) {
                                  titlepi = parallelsArray[parobject].partitle;
                              }
                          }
                          tableplugin += "\n    <td>" + this._computeIcon(relationships[i].icon) + "</td>\n    <td>" + relationships[i].id + "</td>\n    <td>" + titlepi + "</td>\n  </tr>";
                          if (i < relationships.length - 1) {
                              tableplugin += "\n  <tr>";
                          }
                      }
                      tablefinalplugin += tableplugin + "\n</tbody>";
                  }
                  return "<!DOCTYPE html>\n<html>\n<head>\n  <title>" + inputData.id + " " + inputData.titlepi + "</title>\n</head>\n<body>\n<table>\n  <caption>" + inputData.titlepi + "</caption>" + tablefinalplugin + "\n</table>\n</body>\n</html>";
              }
          }

          // creates cite data for parallels with parallels-list and bibliographical information
          _computeCiteData(inputData, parallelsArray) {
              if (inputData.parallels) {
                  citefinalplugin = "";
                  const d = new Date();
                  for (let x = 0; x < inputData.parallels.length; x++) {
                      const relationships = inputData.parallels[x].relations;
                      let citeplugin = "Parallels for " + inputData.parallels[x].id + " " + inputData.titlepi + " (" + inputData.volpage + "): ";
                      for (let i = 0; i < relationships.length; i++) {
                          citeplugin += relationships[i].id;
                          for (let parobject = 0; parobject < parallelsArray.length; parobject++) {
                              if (parallelsArray[parobject].parid === relationships[i].id) {
                                  if (parallelsArray[parobject].volumepage) {
                                      citeplugin += " (" + parallelsArray[parobject].volumepage + ") ";
                                  }
                                  if (parallelsArray[parobject].biblio) {
                                      citeplugin += parallelsArray[parobject].biblio;
                                  }
                              }
                          }
                          if (i < relationships.length - 1) {
                              citeplugin += "; ";
                          }
                      }
                      citefinalplugin += citeplugin + "\n";
                  }
                  return this.citeData = citefinalplugin + "Retrieved from https://suttacentral.net/" + inputData.url + " on " + d + ".";
              }
          }        
      }
      customElements.define(SCMoreParMenu.is, SCMoreParMenu);
  </script>
</dom-module>
