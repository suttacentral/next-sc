<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/iron-icons/editor-icons.html">
<link rel="import" href="/bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="/bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="/bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/iron-meta/iron-meta.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="/bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="/bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="/bower_components/iron-overlay-behavior/iron-overlay-backdrop.html">
<link rel="import" href="/bower_components/neon-animation/web-animations.html">
<link rel="import" href="/bower_components/app-storage/app-localstorage/app-localstorage-document.html">

<!--
Settings menu appears in the toolbar on text pages only. It has setting for textual-details (paragraph numbers),
type of view for segmented pages (showing pali next to translated text), lookup tools and publication details .

Issues:
  - The dictionary lookup does not work yet. There are two of them: Pali to various languages and Chinese to English.
  A mockup dictionary is in `data/dictionaries/pli2en.json` but this is not the latest version, only for testing.
  The matching should be fuzzy so no direct word-to-word lookup.
  - The repository with the basic code for this tool is https://github.com/blake-sc/palilookup but is broken.
-->
<dom-module id="settings-menu" attributes="selectedView textInfo scriptchoice">
  <template>
    <style is="custom-style">
      :host {
        --primary-color: var(--sc-primary-color);
        --accent-color: var(--sc-primary-accent-color);
      }

      .paper-dialogue-container {
        max-width: 40em;
      }

      .dialog-header {
        @apply --paper-font-title;
        @apply --sc-sans-font;
        margin: 0
      }

      #settingsbutton {
        color: var(--sc-tertiary-text-color);
      }

      .dialog-section {
        margin-top: 36px;
      }

      .nerdy-row {
        @apply --sc-paper-font-body;
        @apply --sc-sans-font;
        color: var(--sc-secondary-text-color);
      }

      .menu-item-title {
        @apply --paper-font-title;
        @apply --sc-sans-font;
        color: var(--sc-primary-text-color);
      }

      .menu-option {
        @apply --sc-sans-font;
        --paper-radio-button-unchecked-color: var(--sc-disabled-text-color);
        --paper-radio-button-checked-color: var(--sc-primary-accent-color);
        --paper-radio-button-label-color: var(--sc-primary-text-color);
      }

      .menu-item .menu-icon {
        margin-right: var(--sc-size-xs);
      }

      .menu-item {
        @apply --sc-sans-font;
        @apply --sc-skolar-font-size-md;
        --paper-item-selected-weight: 500;
        cursor: pointer;
        color: var(--secondary-text-color);
      }

      .menu-dropdown, .menu-listbox {
        @apply --sc-skolar-font-size-md;
        --paper-input-container-focus-color: var(--sc-primary-accent-color);
        --paper-input-container-input-color: var(--sc-secondary-text-color);
        --paper-input-container-color: var(--sc-secondary-text-color);
        --paper-dropdown-menu-icon: {
          color: var(--sc-disabled-text-color);
        };
        width: 200px;
      }

      .menu-toggle-button {
        --paper-toggle-button-checked-bar-color: var(--sc-disabled-text-color);
        --paper-toggle-button-checked-button-color: var(--sc-primary-accent-color);
        margin-top: var(--sc-size-sm);
      }

      @media screen and (max-width: 769px) {
        #sides {
          display: none;
        }
      }

      .loading-indicator {
        @apply --sc-skolar-font-size-s;
        width: 90%;
        display: flex;
        text-align: center;
        position: absolute;
        height: inherit;
        justify-content: center;
        align-items: center;
      }
    </style>

    <iron-meta id="meta"></iron-meta>

    <iron-ajax
        id="paragraphs_ajax"
        url="[[_getParagraphsUrl()]]"
        handle-as="json"
        last-response="{{textualInfoResponse}}"></iron-ajax>

    <div class="paper-dialogue-container">
      <div class="loading-indicator">
        <paper-spinner-lite active="[[showLoadingSpinner]]"></paper-spinner-lite>
      </div>

      <div class="dialog-section">
        <h3 class="menu-item-title">View textual information</h3>
        <div class="nerdy-row">Displays information such as volume/page references, variant readings, etc.</div>
        <paper-toggle-button id="textual_info_toggle_button"
                             class="menu-toggle-button" active="{{textualInfoToggleEnabled}}"></paper-toggle-button>
      </div>

      <div class="dialog-section">
        <h3 class="menu-item-title">View original text with translation</h3>
        <div class="nerdy-row">This only works with certain texts, which include translations by Sujato and Brahmali.
        </div>
        <paper-radio-group selected="{{selectedTextView}}">
          <paper-radio-button name="none" class="menu-option">
            None
          </paper-radio-button>
          <paper-radio-button id="sides" name="sidebyside" class="menu-option">
            <iron-icon class="menu-icon" icon="view-column"></iron-icon>
            Side by side
          </paper-radio-button>
          <paper-radio-button name="linebyline" class="menu-option">
            <iron-icon class="menu-icon" icon="view-headline"></iron-icon>
            Line by line
          </paper-radio-button>
          <paper-radio-button name="popup" class="menu-option">
            <iron-icon class="menu-icon" icon="editor:insert-comment"></iron-icon>
            Pop-up
          </paper-radio-button>
        </paper-radio-group>
      </div>

      <div class="dialog-section">
        <h3 class="menu-item-title">Activate Pali word lookup</h3>
        <div class="nerdy-row">Analyzes the Pali text and attempts to display the word meaning. Note that this is an aid
          only, and is not always accurate. Word meanings are from the New Concise Pali English Dictionary.
        </div>
        <paper-dropdown-menu class="menu-dropdown" label="Lookup" id="pali_lookup_menu">
          <paper-listbox class="menu-listbox" slot="dropdown-content" selected="{{paliLookupSelected}}">
            <template is="dom-repeat" items="[[paliLookupArray]]" as="dictlanguage">
              <paper-item class="menu-item">[[dictlanguage.language]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
      </div>

      <div class="dialog-section">
        <h3 class="menu-item-title">Activate Chinese word lookup</h3>
        <div class="nerdy-row">This enables word lookup for ancient Chinese texts. Word meanings are from the Digital
          Dictionary of Buddhism.
        </div>
        <paper-dropdown-menu class="menu-dropdown" label="Lookup" id="chinese_lookup_menu">
          <paper-listbox slot="dropdown-content" selected="{{chineseLookupSelected}}">
            <template is="dom-repeat" items="[[chineseLookupArray]]" as="dictlanguage">
              <paper-item class="menu-item">[[dictlanguage.language]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
      </div>

      <div class="dialog-section">
        <h3 class="menu-item-title">Change the script of the Pali text</h3>
        <div class="nerdy-row">This enables you to read the Pali text in various scripts.</div>
        <paper-dropdown-menu class="menu-dropdown" label="Script">
          <paper-listbox slot="dropdown-content" selected="{{paliScriptSelected}}">
            <template is="dom-repeat" items="[[paliScripts]]" as="script">
              <paper-item class="menu-item">[[script.language]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
      </div>

      <div class="dialog-section">
        <h3 class="menu-item-title">Remember settings</h3>
        <h3 class="nerdy-row">Select this to remember these settings next time you visit SuttaCentral.</h3>
        <paper-toggle-button class="menu-toggle-button" noink checked
                             active="{{rememberSettings}}"></paper-toggle-button>
      </div>

    </div>

    <app-localstorage-document key="rememberTextSettings" data="{{rememberSettings}}"></app-localstorage-document>

  </template>
  <script>
      class SCSettingsMenu extends ReduxMixin(Polymer.Element) {
          static get is() {
              return 'settings-menu';
          }

          static get properties() {
              return {
                  // Selected type of view for segmented-text pages.
                  selectedTextView: {
                      type: String,
                      observer: '_textViewChanged',
                      statePath: 'textOptions.segmentedSuttaTextView'
                  },
                  paliLookupArray: {
                      type: Array,
                      value: [
                          {
                              'dict': 'none',
                              'language': 'None'
                          },
                          {
                              'dict': 'pli2en',
                              'language': 'Pāli → English'
                          },
                          {
                              'dict': 'pli2es',
                              'language': 'Pāli → Español'
                          },
                          {
                              'dict': 'pli2de',
                              'language': 'Pāli → Deutsch'
                          },
                          {
                              'dict': 'pli2zh',
                              'language': 'Pāli → 汉语'
                          },
                          {
                              'dict': 'pli2pt',
                              'language': 'Pāli → Português'
                          },
                          {
                              'dict': 'pli2id',
                              'language': 'Pāli → Bahasa Indonesia'
                          },
                          {
                              'dict': 'pli2nl',
                              'language': 'Pāli → Nederlands'
                          }
                      ]
                  },
                  paliLookupLanguage: {
                      type: String,
                      statePath: 'textOptions.paliLookupTargetDictRepr'
                  },
                  // pali to language lookup selected number.
                  paliLookupSelected: {
                      type: Number,
                      computed: '_findPaliLookupLanguageIndex(paliLookupLanguage)'
                  },
                  // possible values for the chinese to language lookup.
                  chineseLookupArray: {
                      type: Array,
                      value: [
                          {
                              'dict': 'none',
                              'language': 'None'
                          },
                          {
                              'dict': 'lzh2en',
                              'language': '汉语 → English'
                          }
                      ]
                  },
                  chineseLookupLanguage: {
                      type: String,
                      statePath: 'textOptions.chineseLookupTargetDictRepr'
                  },
                  // chinese to language lookup selected number.
                  chineseLookupSelected: {
                      type: Number,
                      computed: '_findChineseLookupLanguageIndex(chineseLookupLanguage)'
                  },
                  // possible values for the script chooser for pali.
                  paliScripts: {
                      type: Array,
                      value: [
                          {
                              'script': 'latin',
                              'language': 'Latin'
                          },
                          {
                              'script': 'sinhala',
                              'language': 'සිංහල'
                          },
                          {
                              'script': 'devanagari',
                              'language': 'नागरी'
                          },
                          {
                              'script': 'thai',
                              'language': 'ไทย'
                          },
                          {
                              'script': 'myanmar',
                              'language': 'မြန်မာဘာသာ'
                          }
                      ]
                  },
                  // pali script selected number.
                  paliScriptSelected: {
                      type: Number,
                      observer: '_changeScript'
                  },
                  // The state of the textual info paper-toggle-button
                  textualInfoToggleEnabled: {
                      type: Boolean,
                      statePath: 'textOptions.paragraphsEnabled'
                  },
                  textualInfoResponse: {
                      type: Object,
                      observer: '_onParagraphsLoaded'
                  },
                  textualParagraphs: {
                      type: Object,
                      statePath: 'textOptions.paragraphDescriptions'
                  },
                  // Boolean that remembers settings on this page.
                  rememberSettings: {
                      type: Boolean
                  },
                  showLoadingSpinner: {
                      type: Boolean,
                      value: false
                  }
              }
          }

          connectedCallback() {
              super.connectedCallback();
              this.shadowRoot.querySelector('#textual_info_toggle_button').addEventListener('checked-changed', (e) => {
                  this._textualInfoToggleStateChanged(e.detail.value);
              });
              this.shadowRoot.querySelector('#pali_lookup_menu').addEventListener('value-changed', (e) => {
                  this._paliLookupChanged(e.detail.value);
              });
              this.shadowRoot.querySelector('#chinese_lookup_menu').addEventListener('value-changed', (e) => {
                  this._chineseLookupChanged(e.detail.value);
              });
          }

          static get actions() {
              return {
                  toggleTextualInfo(enabled) {
                      return {
                          type: 'TOGGLE_TEXTUAL_INFORMATION_ENABLED',
                          enabled: enabled
                      }
                  },
                  downloadParagraphs(data) {
                      return {
                          type: 'DOWNLOAD_PARAGRAPH_DESCRIPTIONS',
                          descriptions: data
                      }
                  },
                  chooseSegmentedSuttaTextView(view) {
                      return {
                          type: 'CHOOSE_SEGMENTED_SUTTA_TEXT_VIEW',
                          view: view
                      }
                  },
                  choosePaliTextScript(script) {
                      return {
                          type: 'CHOOSE_PALI_TEXT_SCRIPT',
                          script: script
                      }
                  },
                  activatePaliLookup(activated, targetLanguage, targetDictRepr) {
                      return {
                          type: 'ACTIVATE_PALI_LOOKUP',
                          paliLookupTargetLanguage: targetLanguage,
                          paliLookupActivated: activated,
                          paliLookupTargetDictRepr: targetDictRepr
                      }
                  },
                  activateChineseLookup(activated, targetLanguage, targetDictRepr) {
                      return {
                          type: 'ACTIVATE_CHINESE_LOOKUP',
                          chineseLookupTargetLanguage: targetLanguage,
                          chineseLookupActivated: activated,
                          chineseLookupTargetDictRepr: targetDictRepr
                      }
                  }
              }
          }

          _textualInfoToggleStateChanged(toggleChecked) {
              if (this.textualParagraphs && toggleChecked) {
                  this.$.paragraphs_ajax.generateRequest().completes.then(() => {
                      this.dispatch('toggleTextualInfo', true);
                  });
              } else {
                  this.dispatch('toggleTextualInfo', false);
              }
          }

          _onParagraphsLoaded() {
              if (this.textualInfoResponse) {
                  if (!this.textualInfoDescriptions || this.textualInfoDescriptions.length === 0) {
                      this.dispatch('downloadParagraphs', this.textualInfoResponse);
                  }
                  this.dispatch('toggleTextualInfo', true);
              }
          }

          _paliLookupChanged(lookupLanguage) {
              if (!lookupLanguage) {
                  return;
              }
              const langIndex = this._findPaliLookupLanguageIndex(lookupLanguage);
              const target = this.paliLookupArray[langIndex];
              const targetLanguage = target.dict.split('2')[1];
              const targetDictRepr = target.language;
              this.dispatch('activatePaliLookup', !!(langIndex), targetLanguage, targetDictRepr);
          }

          _findPaliLookupLanguageIndex(languageName) {
              return this.paliLookupArray.findIndex(i => i.language === languageName);
          }

          _chineseLookupChanged(lookupLanguage) {
              if (!lookupLanguage) {
                  return;
              }
              const langIndex = this._findChineseLookupLanguageIndex(lookupLanguage);
              const target = this.chineseLookupArray[langIndex];
              const targetLanguage = target.dict.split('2')[1];
              const targetDictRepr = target.language;
              this.dispatch('activateChineseLookup', !!(langIndex), targetLanguage, targetDictRepr);
          }

          _findChineseLookupLanguageIndex(languageName) {
              return this.chineseLookupArray.findIndex(i => i.language === languageName);
          }

          _textViewChanged() {
              this.showLoadingSpinner = true;
              setTimeout(() => {
                  this.dispatch('chooseSegmentedSuttaTextView', this.selectedTextView);
                  this.showLoadingSpinner = false;
              }, 0);
          }

          // Fires the choice of pali script to page-selector.html and from there to the segmented text pages.
          _changeScript() {
              this.showLoadingSpinner = true;
              setTimeout(() => {
                  this.dispatch('choosePaliTextScript', this.paliScripts[this.paliScriptSelected].script);
                  this.showLoadingSpinner = false;
              }, 0);
          }

          _getParagraphsUrl() {
              return `${this.$.meta.byKey('API_ROOT')}/paragraphs`;
          }
      }

      customElements.define(SCSettingsMenu.is, SCSettingsMenu);
  </script>
</dom-module>