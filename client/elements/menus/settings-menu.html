<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/iron-icons/editor-icons.html">
<link rel="import" href="/bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="/bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="/bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/iron-meta/iron-meta.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="/bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="/bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="/bower_components/iron-overlay-behavior/iron-overlay-backdrop.html">
<link rel="import" href="/bower_components/neon-animation/web-animations.html">

<!--
Settings menu appears in the toolbar on text pages only. It has setting for textual-details (paragraph numbers),
type of view for segmented pages (showing pali next to translated text), lookup tools and publication details .

Issues:
  - The dictionary lookup does not work yet. There are two of them: Pali to various languages and Chinese to English.
  A mockup dictionary is in `data/dictionaries/pli2en.json` but this is not the latest version, only for testing.
  The matching should be fuzzy so no direct word-to-word lookup.
  - The repository with the basic code for this tool is https://github.com/blake-sc/palilookup but is broken.
-->
<dom-module id="settings-menu" attributes="selectedView textInfo scriptchoice">
  <template>
    <style is="custom-style">
      :host {
        --primary-color: var(--sc-primary-color);
        --accent-color: var(--sc-primary-accent-color);
      }

      .paper-dialogue-container {
        max-width: 40em;
      }

      .dialog-header {
        @apply --paper-font-title;
        @apply --sc-sans-font;
        margin: 0
      }

      #settingsbutton {
        color: white;
      }

      .dialog-section {
        margin-top: 36px;
      }

      .nerdy-row {
        @apply --sc-paper-font-body;
        @apply --sc-sans-font;
        color: var(--sc-secondary-text-color);
      }

      .menu-item-title {
        @apply --paper-font-title;
        @apply --sc-sans-font;
      }

      .menu-option {
        @apply --sc-sans-font;
      }

      .menu-item .menu-icon {
        margin-right: var(--sc-size-xs);
      }

      .menu-item {
        @apply --sc-sans-font;
        @apply --sc-skolar-font-size-md;
      }

      .menu-dropdown, .menu-listbox {
        @apply --sc-skolar-font-size-md;
        width: 200px;
      }

      .menu-toggle-button {
        --paper-toggle-button-checked-bar-color: var(--sc-primary-color-medium);
        --paper-toggle-button-checked-button-color: var(--sc-primary-color);
        margin-top: var(--sc-size-sm);
      }

      @media screen and (max-width: 769px) {
        #sides {
          display: none;
        }
      }

      .loading-indicator {
        @apply --sc-skolar-font-size-s;
        width: 90%;
        display: flex;
        text-align: center;
        position: absolute;
        height: inherit;
        justify-content: center;
        align-items: center;
      }
    </style>

    <iron-meta id="meta"></iron-meta>

    <iron-ajax
        id="paragraphs_ajax"
        url="[[_getParagraphsUrl()]]"
        handle-as="json"
        last-response="{{textualInfoResponse}}"></iron-ajax>

    <div class="paper-dialogue-container">
      <div class="loading-indicator">
        <paper-spinner-lite active="[[showLoadingSpinner]]"></paper-spinner-lite>
      </div>

      <div class="dialog-section">
        <h3 class="menu-item-title">View textual information</h3>
        <div class="nerdy-row">Displays information such as volume/page references, variant readings, etc.</div>
        <paper-toggle-button class="menu-toggle-button" noink
                             active="{{textualInfoToggleEnabled}}"></paper-toggle-button>
      </div>

      <div class="dialog-section">
        <h3 class="menu-item-title">View original text with translation</h3>
        <div class="nerdy-row">This only works with certain texts, which include translations by Sujato and Brahmali.
        </div>
        <paper-radio-group selected="{{selectedTextView}}">
          <paper-radio-button name="none" class="menu-option">
            None
          </paper-radio-button>
          <paper-radio-button id="sides" name="sidebyside" class="menu-option">
            <iron-icon class="menu-icon" icon="view-column"></iron-icon>
            Side by side
          </paper-radio-button>
          <paper-radio-button name="linebyline" class="menu-option">
            <iron-icon class="menu-icon" icon="view-headline"></iron-icon>
            Line by line
          </paper-radio-button>
          <paper-radio-button name="popup" class="menu-option">
            <iron-icon class="menu-icon" icon="editor:insert-comment"></iron-icon>
            Pop-up
          </paper-radio-button>
        </paper-radio-group>
      </div>

      <div class="dialog-section">
        <h3 class="menu-item-title">Activate Pali word lookup</h3>
        <div class="nerdy-row">Analyzes the Pali text and attempts to display the word meaning. Note that this is an aid
          only, and is not always accurate. Word meanings are from the New Concise Pali English Dictionary.
        </div>
        <paper-dropdown-menu class="menu-dropdown" label="Lookup" id="plali_lookup_menu">
          <paper-listbox class="menu-listbox" slot="dropdown-content" selected="{{paliLookupSelected}}">
            <template is="dom-repeat" items="[[paliLookupArray]]" as="dictlanguage">
              <paper-item class="menu-item">[[dictlanguage.language]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
      </div>

      <div class="dialog-section">
        <h3 class="menu-item-title">Activate Chinese word lookup</h3>
        <div class="nerdy-row">This enables word lookup for ancient Chinese texts. Word meanings are from the Digital
          Dictionary of Buddhism.
        </div>
        <paper-dropdown-menu class="menu-dropdown" label="Lookup">
          <paper-listbox slot="dropdown-content" selected="{{chineseLookupSelected}}">
            <template is="dom-repeat" items="[[chineseLookupArray]]" as="dictlanguage">
              <paper-item class="menu-item">[[dictlanguage.language]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
      </div>

      <div class="dialog-section">
        <h3 class="menu-item-title">Change the script of the Pali text</h3>
        <div class="nerdy-row">This enables you to read the Pali text in various scripts.</div>
        <paper-dropdown-menu class="menu-dropdown" label="Script">
          <paper-listbox slot="dropdown-content" selected="{{paliScriptSelected}}">
            <template is="dom-repeat" items="[[paliScripts]]" as="script">
              <paper-item class="menu-item">[[script.language]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
      </div>

      <div class="dialog-section">
        <h3 class="menu-item-title">Remember settings</h3>
        <h3 class="nerdy-row">Select this to remember these settings next time you visit SuttaCentral.</h3>
        <paper-toggle-button class="menu-toggle-button" noink checked
                             active="{{rememberSettings}}"></paper-toggle-button>
      </div>

    </div>

  </template>
  <script>
      class SCSettingsMenu extends ReduxMixin(Polymer.Element) {
          static get is() {
              return 'settings-menu';
          }

          static get properties() {
              return {
                  // Selected type of view for segmented-text pages.
                  selectedTextView: {
                      type: String,
                      observer: '_textViewChanged',
                      statePath: 'textOptions.segmentedSuttaTextView'
                  },
                  paliLookupArray: {
                      type: Array,
                      value: [
                          {
                              'dict': 'none',
                              'language': 'None'
                          },
                          {
                              'dict': 'pli2en',
                              'language': 'Pali → English'
                          },
                          {
                              'dict': 'pli2es',
                              'language': 'Pali → Spanish'
                          },
                          {
                              'dict': 'pli2de',
                              'language': 'Pali → Deutsch'
                          },
                          {
                              'dict': 'pli2zh',
                              'language': 'Pali → Chinese'
                          },
                          {
                              'dict': 'pli2pt',
                              'language': 'Pali → Portugues'
                          },
                          {
                              'dict': 'pli2id',
                              'language': 'Pali → Bahasa Indonesia'
                          },
                          {
                              'dict': 'pli2nl',
                              'language': 'Pali → Nederlands'
                          },
                      ]
                  },
                  // pali to language lookup selected number.
                  paliLookupSelected: {
                      type: Number,
                      value: 0,
                      observer: '_paliLookupChanged'
                  },
                  // possible values for the chinese to language lookup.
                  chineseLookupArray: {
                      type: Array,
                      value: [
                          {
                              'dict': 'none',
                              'language': 'None'
                          },
                          {
                              'dict': 'lzh2en',
                              'language': 'Chinese → English'
                          }
                      ]
                  },
                  // chinese to language lookup selected number.
                  chineseLookupSelected: {
                      type: Number,
                      value: 0
                  },
                  // possible values for the script chooser for pali.
                  paliScripts: {
                      type: Array,
                      value: [
                          {
                              'script': 'latin',
                              'language': 'Latin'
                          },
                          {
                              'script': 'sinhala',
                              'language': 'සිංහල'
                          },
                          {
                              'script': 'devanagari',
                              'language': 'नागरी'
                          },
                          {
                              'script': 'thai',
                              'language': 'ไทย'
                          },
                          {
                              'script': 'myanmar',
                              'language': 'မြန်မာဘာသာ'
                          }
                      ]
                  },
                  // pali script selected number.
                  paliScriptSelected: {
                      type: Number,
                      observer: '_changeScript'
                  },
                  textualInfoEnabled: {
                      type: Boolean,
                      statePath: 'textParagraphs.enabled'
                  },
                  textualInfoDescriptions: {
                      type: Array,
                      statePath: 'textParagraphs.descriptions'
                  },
                  // The state of the textual info paper-toggle-button
                  textualInfoToggleEnabled: {
                      type: Boolean,
                      observer: '_textualInfoToggleStateChanged',
                      value: false
                  },
                  textualInfoResponse: {
                      type: Object,
                      observer: '_onParagraphsLoaded'
                  },
                  // Boolean that remembers settings on this page.
                  rememberSettings: {
                      type: Boolean,
                      value: true,
                      observer: '_rememberSettings'
                  },
                  showLoadingSpinner: {
                      type: Boolean,
                      value: false
                  }
              }
          }

          static get actions() {
              return {
                  toggleTextualInfo(enabled) {
                      return {
                          type: 'TOGGLE_TEXTUAL_INFORMATION_ENABLED',
                          enabled: enabled
                      }
                  },
                  downloadParagraphs(data) {
                      return {
                          type: 'DOWNLOAD_PARAGRAPH_DESCRIPTIONS',
                          descriptions: data
                      }
                  },
                  chooseSegmentedSuttaTextView(view) {
                      return {
                          type: 'CHOOSE_SEGMENTED_SUTTA_TEXT_VIEW',
                          view: view
                      }
                  },
                  choosePaliTextScript(script) {
                      return {
                          type: 'CHOOSE_PALI_TEXT_SCRIPT',
                          script: script
                      }
                  },
                  activatePaliLookup(activated, targetLanguage) {
                      return {
                          type: 'ACTIVATE_PALI_LOOKUP',
                          targetLanguage: targetLanguage,
                          activated: activated
                      }
                  }
              }
          }

          _paliLookupChanged(paliLookupSelected) {
              const target = this.paliLookupArray[paliLookupSelected];
              const targetLanguage = target.dict.split('2')[1];
              this.dispatch('activatePaliLookup', Boolean(paliLookupSelected), targetLanguage);
          }

          _textualInfoToggleStateChanged() {
              if (this.textualInfoToggleEnabled) {
                  this.$.paragraphs_ajax.generateRequest();
              } else {
                  this.dispatch('toggleTextualInfo', false);
              }
          }

          _textViewChanged() {
              this.showLoadingSpinner = true;
              setTimeout(() => {
                  this.dispatch('chooseSegmentedSuttaTextView', this.selectedTextView);
                  this.showLoadingSpinner = false;
              }, 0);
          }

          _onParagraphsLoaded() {
              if (this.textualInfoResponse) {
                  if (!this.textualInfoDescriptions || this.textualInfoDescriptions.length === 0) {
                      this.dispatch('downloadParagraphs', this.textualInfoResponse);
                  }
                  this.dispatch('toggleTextualInfo', this.textualInfoToggleEnabled);
              }
          }

          _rememberSettings(rememberSettings) {
              // TODO
              // sets the attribute sessionOnly on the app-localstorage so whatever the user chooses after
              // setting this attribute will not be stored but settings before setting this attribute will be maintained.
          }

          _dictionaryLookup(valueSelected) {
              // needs more work
              return (valueSelected > 0);
          }

          _getDictionary(valueArray, valueSelected) {
              // needs more work
              return valueArray[valueSelected].dict;
          }

          // Fires the choice of pali script to page-selector.html and from there to the segmented text pages.
          _changeScript() {
              this.showLoadingSpinner = true;
              setTimeout(() => {
                  this.dispatch('choosePaliTextScript', this.paliScripts[this.paliScriptSelected].script);
                  this.showLoadingSpinner = false;
              }, 0);
          }

          _getParagraphsUrl() {
              return `${this.$.meta.byKey('API_ROOT')}/paragraphs`;
          }
      }

      customElements.define(SCSettingsMenu.is, SCSettingsMenu);
  </script>
</dom-module>