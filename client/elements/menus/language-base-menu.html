<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="/bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/bower_components/paper-item/paper-item-body.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/neon-animation/web-animations.html">

<link rel="import" href="/redux-store.html">

<!--
This is the base language menu that determines the language of the site.
-->
<dom-module id="language-base-menu" attributes="Language">
  <template>
    <style>
      :host {
        --primary-color: var(--sc-primary-color);
        --paper-menu-button-content: {
          display: block;
        };
      }

      .language-menu-container {
        @apply --sc-skolar-font-size-md;
        --paper-input-container-underline: {
          color: blue;
        };
        --paper-input-container-focus-color: var(--sc-primary-accent-color);
        --paper-input-container-color: var(--sc-secondary-text-color);
        --paper-dropdown-menu-icon: {
          color: var(--sc-disabled-text-color);
        }
      }

      .language-menu-paper-item {
        @apply --sc-sans-font;
        @apply --sc-skolar-font-size-md;
        color: var(--sc-primary-text-color);
        text-transform: capitalize;
        width: 180px;
      }

      .language-menu-paper-item:hover {
        cursor: pointer;
        background-color: var(--sc-tertiary-background-color);
      }

      .iso-code {
        @apply --paper-font-caption;
        @apply --sc-sans-font;
        color: var(--sc-secondary-text-color);
        position: absolute;
        right: var(--sc-size-md);
        margin-top: -34px;
        text-transform: none;
        pointer-events: none;
      }
    </style>

    <iron-meta id="meta"></iron-meta>

    <iron-ajax
        auto
        url='[[_getUrl()]]'
        handle-as="json"
        last-response="{{lastResponse}}"></iron-ajax>

    <paper-dropdown-menu class="language-menu-container" label="Language" title="Select the site in another language">
      <paper-listbox class="language-menu-container" slot="dropdown-content" selected="{{selectedLanguageNr}}">
        <template is="dom-repeat" items="{{lastResponse}}" as="language">
          <paper-item class="language-menu-paper-item" id='[[language.uid]]'>
            <paper-item-body>
              [[language.name]]
            </paper-item-body>
          </paper-item>
          <!-- These ISO codes technically count as separate paper-listbox elements. -->
          <div class="iso-code">[[language.iso_code]]</div>
        </template>
      </paper-listbox>
    </paper-dropdown-menu>
  </template>

  <script>
      class LanguageBaseMenu extends ReduxMixin(Polymer.Element) {
          static get is() {
              return 'language-base-menu';
          }

          static get properties() {
              return {
                  lastResponse: {
                      type: Array,
                      value: () => { return []; }
                  },
                  selectedLanguageNr: {
                      type: Number,
                      observer: '_selectedLanguageNrChanged'
                  },
                  siteLanguage: {
                      type: String,
                      statePath: 'siteLanguage'
                  },
                  isoCodes: {
                      type: Array,
                      statePath: 'language.isoCodes'
                  }
              };
          }

          // Redux actions
          static get actions() {
              return {
                  changeLanguage(language) {
                      return {
                          type: 'CHANGE_SITE_LANGUAGE',
                          language: language
                      }
                  }
              }
          }

          // Is invoked when a language is chosen from the list.
          _selectedLanguageNrChanged() {
              if (!this.lastResponse || this.lastResponse.length === 0 || !this.selectedLanguageNr) {
                  return;
              }
              try {
                  // When selecting a language from the array of all languages, we're dividing by two.
                  // That's because of the ISO codes inside our list which paper-listbox treats as separate elements.
                  const languageIsoCode = this.lastResponse[this.selectedLanguageNr / 2].iso_code;
                  this.dispatch('changeLanguage', languageIsoCode);
              } catch (e) {
                  console.error(e);
              }
          }

          // Listens to changes in the global redux app state and updates the language chosen in the list dropdown.
          _computeSelectedLanguageNr(chosenLanguageIsoCode) {
              try {
                  return this.isoCodes.indexOf(chosenLanguageIsoCode) * 2;
              } catch (e) {
                  console.error(e);
                  return 0;
              }
          }

          _getUrl() {
              return `${this.$.meta.byKey('API_ROOT')}/languages`;
          }
      }

      customElements.define(LanguageBaseMenu.is, LanguageBaseMenu);
  </script>
</dom-module>
