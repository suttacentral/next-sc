<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html">

<!--
This is the base language menu that determines the language of all pages. Dropdown inside the toolbar more-vert-menu.
The last chosen language is remembered through app-localstorage.
-->
<dom-module id="language-base-menu" attributes="Language">
  <template>
    <style is="custom-style">
      :host {
        --primary-color: var(--sc-gold-500);
      }

      paper-dropdown-menu, paper-listbox {
        @apply --sc-skolar-font-size-md;
        width: 200px;
      }

      paper-item {
        @apply --sc-sans-font;
        @apply --sc-skolar-font-size-md;
        text-transform: capitalize;
      }

      .iso-code {
        color: var(--secondary-text-color);
        @apply --paper-font-caption;
        @apply --sc-sans-font;
        position: absolute;
        right: 15px;
        margin-top: -34px;
        text-transform: none;
        pointer-events: none;
      }
    </style>

    <iron-ajax
        auto
        url='api/languages'
        handle-as="json"
        last-response="{{allLanguages}}"
        on-response="computeNewLanguage"></iron-ajax>

    <paper-dropdown-menu class="custom" label="Language" title="Select the site in another language">
      <paper-listbox slot="dropdown-content" selected="{{selectedLanguageNr}}">
        <template is="dom-repeat" items="{{allLanguages}}" as="language">
          <paper-item id='[[language.uid]]'>
            <paper-item-body>[[language.name]]</paper-item-body>
          </paper-item>
          <div class="iso-code">[[language.iso_code]]</div>
        </template>
      </paper-listbox>
      <app-localstorage-document key="selectedLanguageNr" data="{{selectedLanguageNr}}"></app-localstorage-document>
    </paper-dropdown-menu>
  </template>

  <script>
      class LanguageBaseMenu extends Polymer.Element {
          static get is() {
              return 'language-base-menu'
          }

          static get properties() {
              return {
                  languages: {
                      type: Array,
                      notify: true,
                      value: () => []
                  },
                  selectedLanguageNr: {
                      type: Number,
                      value: 0,
                      notify: true,
                      observer: '_languageChanged'
                  }
              };
          }

          // TODO: set new language here
          _languageChanged() {
          }

          // Will compute the equivalent language code to the chosen language.
          computeNewLanguage(e) {
              const allLanguages = e.detail.response;
              if (allLanguages[this.selectedLanguageNr]) {
                  this.passNewLanguageSelected(allLanguages[this.selectedLanguageNr].id);
              } else {
                  this.passNewLanguageSelected("en");
              }
          }

          // Pass chosen language code on to main page sc-navdrawer.html
          passNewLanguageSelected(selectedLanguage) {
              this.dispatchEvent(new Event('languageSelection', {Language: selectedLanguage}));
          }
      }
      customElements.define(LanguageBaseMenu.is, LanguageBaseMenu);
  </script>
</dom-module>
