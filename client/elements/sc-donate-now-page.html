<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="/bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/paper-input/paper-textarea.html">
<link rel="import" href="/bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="/bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="/bower_components/iron-icon/iron-icon.html">
<link rel="import" href="/bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/bower_components/paper-item/paper-item-body.html">
<link rel="import" href="/bower_components/iron-icon/iron-icon.html">
<link rel="import" href="/bower_components/iron-form/iron-form.html">
<link rel="import" href="/bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="/bower_components/iron-location/iron-location.html">
<link rel="import" href="/bower_components/paper-toast/paper-toast.html">

<link rel="import" href="/styles/static-styles.html">

<dom-module id="sc-donate-now-page">
  <template>
    <style include="static-styles">
      #page-wrap {
        @apply --sc-sans-font;
      }

      .flex-row {
        display: flex;
      }

      .form-prefix {
        margin-right: 0.5em;
      }

      .data-input {
        --paper-input-container-focus-color: var(--sc-green-600);
      }

      .currency-dropdown {
        width: 6em;
      }

      .currency-menu-listbox {
        width: 6em;
      }

      .currency-menu-item:hover {
        background-color: var(--paper-grey-200);
        cursor: pointer;
      }

      .frequency-checkbox {
        margin-right: 1em;
        --paper-checkbox-checked-color: var(--sc-green-600);
      }

      .explanation {
        margin-bottom: 0;
        color: var(--secondary-text-color);
      }

      .legal-information {
        margin-top: 3em;
        padding-bottom: 1em;
        color: var(--secondary-text-color);
      }

      .submit {
        width: 100%;
        justify-content: flex-end;
        margin-top: 1.5em;
      }

      .submit-button {
        background: var(--sc-green-600);
        color: white;
        font-weight: bold;
      }

      .submit-button[disabled] {
        background: var(--paper-grey-400);
      }

      .card-details {
        font-size: 19px;
        padding: 0;
        margin: 0;
      }

      .card-row {
        margin-top: 2.5em;
        margin-bottom: 1.2em;
      }

      .card-label {
        height: 35px;
        position: relative;
        color: #000000;
        display: block;
        margin-top: 30px;
        margin-bottom: 10px;
      }

      .card-first-span {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        font-weight: 300;
        line-height: 32px;
        color: #737373;
        border-bottom: 1px solid #586A82;
        transition: border-bottom-color 200ms ease-in-out;
        cursor: text;
        pointer-events: none;
      }

      .card-second-span {
        opacity: 0;
        position: absolute;
        top: 0;
        left: 0;
        transform-origin: 0% 50%;
        transition: transform 200ms ease-in-out;
        cursor: text;
      }

      label .field:not(.is-empty) + span span {
        transform: scale(0.70) translateY(-36px);
        cursor: default;
        opacity: 1;
      }

      label .field.is-focused + span span {
        color: var(--sc-green-600);
      }

      label .field.is-focused + span {
        border-bottom: 2px solid var(--sc-green-600);
      }

      .field {
        background: transparent;
        font-weight: 300;
        border: 0;
        color: white;
        outline: none;
        cursor: text;
        display: block;
        width: 100%;
        line-height: 32px;
        padding-bottom: 3px;
        transition: opacity 200ms ease-in-out;
      }

      .field::-webkit-input-placeholder { color: #000000; }
      .field::-moz-placeholder { color: #000000; }

      /* IE doesn't show placeholders when empty+focused */
      .field:-ms-input-placeholder { color: #000000; }

      .success, .error {
        display: none;
        font-size: 15px;
      }

      .success.visible, .error.visible {
        display: inline;
      }

      .error {
        color: #E4584C;
      }

      .error-bar {
        border-bottom: 2px solid  #E4584C;
      }

      .success {
        color: var(--sc-green-600);
      }

      .success .token {
        font-weight: 500;
        font-size: 15px;
      }

      .spinner {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translateY(-50%);
        z-index: 101;
      }

      .no-d {
        display: none;
      }

      .blocker {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 1;
        z-index: 100;
      }
      
      .toast {
        @apply --sc-sans-font;
        --paper-toast-color: white;
        text-align: center;
        font-size: 20px;
        margin-left: calc(50vw - 150px);
      }

      .sans-font {
        @apply --sc-sans-font;
      }

      .data-input{
        --paper-input-container: {
          @apply --sc-sans-font;
          color: var(--secondary-text-color);
        };
        padding-bottom: var(--size-md);
      }

      .form-prefix {
        color: var(--disabled-text-color);
      }

      .success-toast {
        --paper-toast-background-color: var(--paper-green-a700);
      }

      .error-toast {
        --paper-toast-background-color: red;
      }

    </style>
    <iron-ajax
            id='currency_ajax'
            auto
            url="/api/currencies"
            handle-as="json"
            last-response="{{ responseData }}"
            on-response="_handleResponse"></iron-ajax>
    
    <iron-ajax
            class="make-donation-ajax"
            url="/api/donate"
            handle-as="json"
            method="post"
            body="{{ formData }}"
            last-response="{{ donationResponseData }}"
            last-error="{{ donationResponseError}}"
            on-error="_paymentError"
            on-response="_paymentFinished"></iron-ajax>

    <iron-location path="{{path}}"></iron-location>

    <div id="page-wrap">
      <section>
        <iron-form class="payment-iron-form">
        <form class="payment-form">
          <div class="flex-row">
            <paper-dropdown-menu class="form-prefix currency-dropdown data-input" title="Select currency"
                                  dynamic-align label="Currency" always-float-label>
              <paper-listbox slot="dropdown-content" class="currency-menu-listbox"
                              selected="[[default_currency_index]]">
                <template is="dom-repeat" items="{{ currencies }}">
                  <paper-item class="currency-menu-item" title="[[item.name]]">
                    <paper-item-body>
                      [[item.symbol]]
                    </paper-item-body>
                  </paper-item>
                </template>
              </paper-listbox>
            </paper-dropdown-menu>

            <paper-input label="Amount" class="data-input amount-input" auto-validate pattern="^[+]?(\d+[.,]?\d{0,2})$" 
                         allowed-pattern="[0-9.,]" error-message="Invalid value" required maxlength=20></paper-input>
          </div>

          <p class="explanation">You can make a one-time donation or a monthly donation.</p>
          <div class="flex-row">
            <paper-checkbox class="sans-font frequency-checkbox one-time-donation" checked>One time</paper-checkbox>
            <paper-checkbox class="sans-font frequency-checkbox monthly-donation">Monthly</paper-checkbox>
          </div>

          <div class="card-row">
            <div class="card-details">
              <label class="card-label">
                <div id="card-element" class="field is-empty"></div>
                <span class="card-first-span"><span class="card-second-span">Card number</span></span>
              </label>
            </div>
          </div>

          <paper-input label="Name (optional)" class="data-input name-input" maxlength=200>
            <iron-icon icon="social:person" slot="prefix" class="form-prefix"></iron-icon>
          </paper-input>

          <paper-input label="Email (optional)" class="data-input email-input" auto-validate pattern="^\S+@\S+\.\S+$"
                        error-message="Invalid email" maxlength=200>
            <iron-icon icon="mail" slot="prefix" class="form-prefix"></iron-icon>
          </paper-input>

          <paper-textarea label="Message (optional)" class="data-input message-input" rows=2 maxlength=200 char-counter>
          </paper-textarea>

          <div class="flex-row submit">
            <paper-button  id="submitButton" on-tap="_makeDonation" class="submit-button" raised>
              <div class="sans-font">PAY WITH CARD</div>
            </paper-button>
          </div>
        </form>
      </iron-form>
            
        <div class="legal-information">
            <iron-icon icon="icons:info-outline"></iron-icon><p>SuttaCentral does not handle or store your credit card details. 
            All credit card transactions are handled securely by <a href="https://stripe.com" target="blank">Stripe</a>.</p>
            <p>The Stripe handling fee deducted from a donation is 1.75% + 30¢ for Australian cards,
              and 2.9% + 30¢ for International cards, plus a 1.8% currency conversion fee when applicable.</p>
        </div>
      </section>
    </div>
    <paper-toast class="toast error-toast" text="[[errorMessage]]" duration=5000></paper-toast>
    <paper-toast class="toast success-toast" text="[[successMessage]]" duration=5000></paper-toast>
    <template is="dom-if" if="{{processingPayment}}">
      <div class="blocker"></div>
      <div class="spinner">
        <paper-spinner active></paper-spinner>
      </div>
    </template>

  </template>

  <script>
      class SCDonateNow extends Polymer.Element {
          static get is() {
              return 'sc-donate-now-page';
          }

          static get properties() {
              return {
                  responseData: {
                      type: Object
                  },
                  currencies: {
                      type: Array
                  },
                  default_currency_index: {
                      type: Number
                  },
                  data: {
                    type: Object
                  },
                  donationResponse: {
                    type: Object
                  },
                  path: {
                    type: String
                  },
                  formData: {
                    type: String
                  },
                  donationResponseData: {
                    type: Object
                  },
                  donationResponseError: {
                    type: Object
                  },
                  processingPayment: {
                    type: Boolean,
                  },
                  errorMessage: {
                    type: String,
                    value: 'Error!'
                  },
                  isStripeValid: {
                    type: Boolean,
                    value: false
                  },
                  errorMessages: {
                    type: Object,
                    value: {
                      0: 'Unknown error',
                      1: 'Amount cannot be less than $0.50 USD.',
                      2: 'Due to Stripe limitations,  please make a direct payment, or else contact us for help.',
                      3: 'Your card was declined.'
                    }
                  },
                  successMessage: {
                    type: String,
                    value: 'Sadhu! Your payment has been completed successfully. You will be redirected in 5 seconds.'
                  }
              }
          }

          constructor() {
              super();
              this.stripe = Stripe('pk_test_vFqwBPDW08c5AKXMGLKaeJaB');
              this.stripe_elements = this.stripe.elements();
          }

          ready() {
              super.ready();
              let stripe_div = this.shadowRoot.querySelector('#card-element');

              this.card = this.stripe_elements.create('card', {
                iconStyle: 'solid',
                style: {
                  base: {
                    iconColor: '#9A9A9A',
                    lineHeight: '36px',
                    fontWeight: 300,
                    fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
                    fontSize: '19px',
              
                    '::placeholder': {
                      color: '#737373',
                    },
                  },
                  invalid: {
                    iconColor: '#e85746',
                    color: '#e85746',
                  }
                },
                classes: {
                  focus: 'is-focused',
                  empty: 'is-empty',
                },

              });
              this.card.mount(stripe_div);

              let cardFirstSpan = this.shadowRoot.querySelector('.card-first-span');
              let cardSecondSpan = this.shadowRoot.querySelector('.card-second-span');     

              this.card.addEventListener('change', ({error, empty}) => {
                  if (error || empty) {
                    cardFirstSpan.classList.add('error-bar');
                    cardSecondSpan.style['color'] = '#E4584C';
                    this.isStripeValid = false;
                  } else {
                    cardFirstSpan.classList.remove('error-bar');
                    cardSecondSpan.style['color'] = '';
                    this.isStripeValid = true;
                  }
              });

              let oneTimeDonation = this.shadowRoot.querySelector('.one-time-donation');
              let monthly = this.shadowRoot.querySelector('.monthly-donation');

              oneTimeDonation.addEventListener('click', (e) => {
                  oneTimeDonation.checked = true;
                  monthly.checked = false;
              });

              monthly.addEventListener('click', (e) => {
                  oneTimeDonation.checked = false;
                  monthly.checked = true;
              });
              
              let amountInput = this.shadowRoot.querySelector('.amount-input'); 
              amountInput.onpaste = (e) => {  // Don't allow pasting text data.
                let pastedText = '';
                if (window.clipboardData && window.clipboardData.getData) { // IE
                    pastedText = window.clipboardData.getData('Text');
                } else if (e.clipboardData && e.clipboardData.getData) {
                    pastedText = e.clipboardData.getData('text/plain');
                }
                if (!/^[+]?(\d+[.,]?\d{0,2})$/.test(pastedText)){
                  return false;
                }
              }

              amountInput.addEventListener('keydown', (e) => {
                if (e.key === ','){
                  let posiiton = amountInput.$.nativeInput.selectionStart;
                  amountInput.value = amountInput.value.slice(0, posiiton) + '.' + amountInput.value.slice(posiiton);
                  posiiton += 1;
                  e.preventDefault();
                }
              })
          }

          _handleResponse() {
              this.currencies = this.responseData.currencies;
              this.default_currency_index = this.responseData.default_currency_index;
          }

          _makeDonation(e) {
            let ironForm = this.shadowRoot.querySelector('.payment-iron-form');
            if(!this.isStripeValid){
              this.shadowRoot.querySelector('.card-first-span').classList.add('error-bar');
              return;
            }
            if(!ironForm.validate()){
              return;
            }
            let data = this._getFormData();
            this.processingPayment = true;
            this.$.submitButton.disabled = true;
            this.stripe.createToken(this.card).then((result, error) => {
              if (error){
                console.log(error);
                this.shadowRoot.querySelector('.error-toast').open();
                this.processingPayment = false;
                this.$.submitButton.disabled = false;
                return;
              }
              data.stripe = result;
              this.formData = JSON.stringify(data);
              let ironAjax = this.shadowRoot.querySelector('.make-donation-ajax');
              ironAjax.generateRequest();
            });
          }

          _paymentFinished(event) {
              this.processingPayment = false;
              let successToast = this.shadowRoot.querySelector('.success-toast');
              successToast.open();
              setTimeout(() => { 
                this.$.submitButton.disabled = false;
                this.set('path', '/');
              }, successToast.duration + 500);
          }

          _paymentError(event) {
            this.$.submitButton.disabled = false;
            let errCode = this.donationResponseError.response['err_code']
            this.errorMessage = this.errorMessages[errCode];
            this.processingPayment = false;
            this.shadowRoot.querySelector('.error-toast').open();
          }

          _getFormData() {
              let form = this.shadowRoot.querySelector('.payment-form');

              let data = {};

              let currency = form.querySelector('.currency-menu-listbox').selected;
              data.currency = this.currencies[currency].symbol;

              data.amount = parseFloat(form.querySelector('.amount-input').value);
              data.oneTimeDonation = form.querySelector('.one-time-donation').checked;
              data.monthlyDonation = form.querySelector('.monthly-donation').checked;
              data.name = form.querySelector('.name-input').value;
              data.email = form.querySelector('.email-input').value;
              data.message = form.querySelector('.message-input').value;
              return data;
          }
      }

      customElements.define(SCDonateNow.is, SCDonateNow);
  </script>
</dom-module>
