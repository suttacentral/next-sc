<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<dom-module id="paper-tree-node">
  <template>
    <style>
      :host(.selected) > .node-container > .node-row {
        background: linear-gradient(to right, rgba(223, 153, 10, 1) 4px, rgba(223, 153, 10, 0) 4px);
      }

      :host(.selected) > .node-container > .node-row > #actions {
        display: inline-block;
      }

      :host(.selected) > .node-container > .node-row a {
        color: var(--sc-gold-500);
      }

      .node-row {
        @apply --paper-font-body2;
        @apply --sc-sans-font;
        width: 100%;
        white-space: nowrap;
        position: relative;
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }

      .paper-tree-link {
        text-transform: none;
        letter-spacing: 0;
        text-decoration: none;
        color: var(--paper-green-500);
        cursor: pointer;
      }

      .paper-tree-toggle-button {
        color: var(--disabled-text-color);
        cursor: pointer;
        float: right;
        margin-right: 6px;
      }

      .paper-tree-icon {
        margin-left: 4px;
      }

      .data-lang {
        @apply --sc-skolar-font-size-xs;
        padding-left: 12px;
        color: var(--secondary-text-color);
        font-weight: normal;
      }

      .data-name {
        padding: 4px 0 4px 16px;
        margin: 4px 0;
        display: inline-block;
        width: 70%;
      }

      .small-indent {
        padding-left: 8px;
      }

      .light-font {
        font-weight: 400;
      }

      .thick-font {
        font-weight: 700;
        font-size: calc(1.1em * var(--sc-skolar-font-scale));
      }

      .full-height {
        height: 100vh;
      }
    </style>

    <div class="node-container">
      <div class="node-row">

        <template is="dom-if" if="{{data.icon}}">
          <iron-icon class="paper-tree-icon" icon="[[data.icon]]"></iron-icon>
        </template>

        <template is="dom-if" if="{{data.children}}">
          <paper-icon-button class="paper-tree-toggle-button" icon="{{_computeIcon(data.*)}}" on-tap="toggleChildren"></paper-icon-button>
        </template>

        <template is="dom-if" if="{{_computeClickable(data.uid)}}">
          <a class="paper-tree-link" href$="{{_computeLink(data.uid)}}">
            <span class="node-name">
              <span class="data-name">{{data.name}}
                <span class="data-lang">{{data.lang}}</span>
              </span>
            </span>
          </a>
        </template>

        <template is="dom-if" if="{{!_computeClickable(data.uid)}}">
          <span class="node-name" on-tap="_select">
            <span class$="data-name {{_computeFontWeight(data.uid)}}" inner-h-t-m-l="{{data.name}}">
              <span class="data-lang">{{data.lang}}
              </span>
            </span>
          </span>
        </template>

      </div>

      <iron-collapse opened="{{data.open}}">
        <template is="dom-if" if="{{data.open}}">
          <template is="dom-repeat" items="{{data.children}}">
            <paper-tree-node data="{{item}}" is-wide="[[isWide]]"></paper-tree-node>
          </template>
        </template>

        <!--Dummy element that enables rolldown animation with iron-collapse-->
        <template is="dom-if" if="{{!data.open}}">
          <template is="dom-if" if="{{data.children}}">
            <div class="full-height" style="background-color: blue;"></div>
          </template>
        </template>
      </iron-collapse>

    </div>
  </template>

  <script>
      class PaperTreeNodeSC extends Polymer.Element {
          static get is() {
              return 'paper-tree-node';
          }

          static get properties() {

              /**
               * Data held by this node (contains the children).
               *
               * Specific data:
               *
               * - `data.name`: string representing the node name.
               * - `data.icon`: string telling which icon to use (default to 'folder' icon).
               * - `data.open`: boolean telling whether the node is expanded or not.
               * - `data.children` array containing the children of the node.
               */

              return {
                  data: {
                      type: Object,
                      notify: true,
                      value: function() {
                          return null;
                      }
                  },
                  indented: {
                      type: Boolean,
                      value: false
                  },
                  isWide: {
                      type: Boolean,
                      observer: '_screenWidthChanged'
                  }
              }
          }

          /**
           * Returns the necessary classes.
           *
           * @param {object} change An object containing the property that changed and its value.
           * @return {string} The class name indicating whether the node is open or closed
           */
          _computeIcon(change) {
              const open = change && change.base && change.base.open;
              const children = change && change.base && change.base.children;
              return ((open && children && children.length) ? 'expand-less' : children && children.length ? 'expand-more' : '');
          }

          _computeSmallIndent() {
              return this.indented ? 'small-indent' : '';
          }

          /**
           * Checks if the element should be a link.
           *
           * @param uid the uid of the menu item, typically looks like this: "root/su1"
           * @returns {boolean} Whether the node should be clickable and should lead to a text / suttaplex list
           */
          _computeClickable(uid) {
              return uid.split('\/')[0] === 'root';
          }

          _computeFontWeight(uid) {
              return uid.split('\/')[0] === 'grouping' ? 'light-font' : 'thick-font';
          }

          _computeLink(uid) {
              return uid.substring(uid.indexOf('\/'), uid.length);
          }

          /**
           * Highlights node as the selected node.
           */
          _select() {
              this.dispatchEvent(new CustomEvent('select', { detail: this, composed: true, bubbles: true }));
              this.toggleChildren();
          }

          /**
           * Returns the parent node. Returns `null` if root.
           */
          getParent() {
              return this.domHost.tagName === 'PAPER-TREE-NODE' ? this.domHost : null;
          }

          /**
           * Returns the children tree nodes.
           */
          getChildren() {
              return this.shadowRoot.querySelectorAll('paper-tree-node');
          }

          /**
           * Reacts to the screen width change and sets the indentation accordingly (no indent on small screens)
           */
          _screenWidthChanged() {
              this.shadowRoot.querySelector('.node-container').classList.toggle('small-indent', !!this.isWide);
          }

          /**
           * Display/Hide the children nodes.
           */
          toggleChildren() {
              this.opened = !this.opened;
              this.dispatchEvent(new CustomEvent('toggle', { detail: this }));
              this.set('data.open', !this.data.open && this.data.children && this.data.children.length);
          }

      }

      customElements.define(PaperTreeNodeSC.is, PaperTreeNodeSC);
  </script>
</dom-module>
