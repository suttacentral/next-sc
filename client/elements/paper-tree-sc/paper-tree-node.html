<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<dom-module id="paper-tree-node">
  <template>
    <style>
      :host(.selected) > .node-container > .node-row {
        background: linear-gradient(to right, rgba(223, 153, 10, 1) 4px, rgba(223, 153, 10, 0) 4px);
      }

      :host(.selected) > .node-container > .node-row > #actions {
        display: inline-block;
      }

      :host(.selected) > .node-container > .node-row a {
        color: var(--sc-gold-500);
      }

      .node-row {
        width: 100%;
        white-space: nowrap;
        @apply --paper-font-body2;
        position: relative;
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }

      .node-row a {
        text-transform: none;
        letter-spacing: 0;
        text-decoration: none;
        color: var(--paper-green-500);
        cursor: pointer;
      }

      paper-icon-button {
        color: var(--disabled-text-color);
        cursor: pointer;
        float: right;
        margin-right: 6px;
      }

      .data-lang {
        padding-left: 12px;
        color: var(--secondary-text-color);
        font-size: 12px;
        font-weight: normal;
      }

      .data-name {
        padding: 4px 0 4px 16px;
        margin: 4px 0;
        display: inline-block;
        width: 70%;
      }

      .indent {
        padding-left: 32px;
      }

      ul {
        margin: 0;
        padding-left: 0;
      }

      li {
        list-style-type: none;
      }
    </style>

    <div class="node-container">
      <div class="node-row">

        <template is="dom-if" if="{{data.children}}">
          <paper-icon-button icon="{{_computeIcon(data.*)}}" on-tap="toggleChildren"></paper-icon-button>
        </template>

        <template is="dom-if" if="{{_computeClickable(data.uid)}}">
          <a href$="/{{data.uid}}">
            <span class="node-name" on-tap="select">
              <span class$="data-name {{_computeIndent(data)}}">{{data.name}}
                <span class="data-lang">{{data.lang}}</span>
              </span>
            </span>
          </a>
        </template>

        <template is="dom-if" if="{{!_computeClickable(data.uid)}}">
          <span class="node-name" on-tap="select">
            <span class="data-name" inner-h-t-m-l="{{data.name}}">
              <span class="data-lang">{{data.lang}}
              </span>
            </span>
          </span>
        </template>

      </div>

      <iron-collapse id="collapse" opened="{{opened}}">
        <ul class$={{!data.open}}>
          <template is="dom-if" if="{{data.open}}">
            <template is="dom-repeat" items="{{data.children}}">
              <li>
                <paper-tree-node id="{{item.uid}}" data="{{item}}"></paper-tree-node>
              </li>
            </template>
          </template>
        </ul>
      </iron-collapse>

    </div>
  </template>

  <script>
      class PaperTreeNodeSC extends Polymer.Element {
          static get is() {
              return 'paper-tree-node';
          }

          static get properties() {

              /**
               * Data held by this node (contains the children).
               *
               * Specific data:
               *
               * - `data.name`: string representing the node name.
               * - `data.icon`: string telling which icon to use (default to 'folder' icon).
               * - `data.open`: boolean telling whether the node is expanded or not.
               * - `data.children` array containing the children of the node.
               */

              return {
                  data: {
                      type: Object,
                      value: function() {
                          return null;
                      }
                  }
              }
          }

          /**
           * Returns the necessary classes.
           *
           * @param {object} change An object containing the property that changed and its value.
           * @return {string} The class name indicating whether the node is open or closed
           */
          _computeIcon(change) {
              const open = change && change.base && change.base.open;
              const children = change && change.base && change.base.children;
              return ((open && children && children.length) ? 'expand-less' : children && children.length ? 'expand-more' : '');
          }

          _computeIndent(data) {
              return (data.children || data.lang) ? "" : "indent";
          }

          /**
           * Highlights node as the selected node.
           */
          select() {
              this.dispatchEvent(new CustomEvent("select", {detail: this}));
          }

          /**
           * Returns the parent node. Returns `null` if root.
           */
          getParent() {
              return this.domHost.tagName === 'PAPER-TREE-NODE' ? this.domHost : null;
          }

          /**
           * Returns the children tree nodes.
           */
          getChildren() {
              return this.shadowRoot.querySelectorAll('paper-tree-node');
          }

          /**
           * Display/Hide the children nodes.
           */
          toggleChildren(e) {
              this.opened = !this.opened;
              this.dispatchEvent(new CustomEvent('toggle', {detail: this}));
              this.set("data.open", !this.data.open && this.data.children && this.data.children.length);
          }

          /**
           * Checks if the element should be a link.
           *
           * @param uid the uid of the menu item, typically looks like this: "root/su1"
           * @returns {boolean} Whether the node should be clickable and should lead to a text / suttaplex list
           */
          _computeClickable(uid) {
              return uid.split("\/")[0] === "root";
          }
      }

      customElements.define(PaperTreeNodeSC.is, PaperTreeNodeSC);
  </script>
</dom-module>
