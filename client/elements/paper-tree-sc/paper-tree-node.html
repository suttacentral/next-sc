<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<dom-module id="paper-tree-node">
  <template>
    <custom-style>
      <style>
        :host(.selected) > .node-container > .node-row {
          background: linear-gradient(to right, rgba(223, 153, 10, 1) 4px, rgba(223, 153, 10, 0) 4px);
        }

        :host(.selected) > .node-container > .node-row > #actions {
          display: inline-block;
        }

        :host(.selected) > .node-container > .node-row a {
          color: var(--sc-gold-500);
        }

        .node-row {
          width: 100%;
          white-space: nowrap;
          @apply --paper-font-body2;
          position: relative;
          text-transform: uppercase;
          letter-spacing: 0.04em;
        }

        .node-row a {
          text-transform: none;
          letter-spacing: 0;
          text-decoration: none;
          color: var(--paper-green-500);
          cursor: pointer;
        }

        paper-icon-button {
          color: var(--disabled-text-color);
          cursor: pointer;
          float: right;
          margin-right: 6px;
        }

        .data-lang {
          padding-left: 12px;
          color: var(--secondary-text-color);
          font-size: 12px;
          font-weight: normal;
        }

        .data-name {
          padding: 4px 0 4px 16px;
          margin: 4px 0;
          display: inline-block;
          width: 70%;
        }

        .indent {
          padding-left: 32px;
        }

        .small-indent {
          padding-left: 8px;
        }

        ul {
          margin: 0;
          padding-left: 0;
        }

        li {
          list-style-type: none;
        }

        .light-font {
          font-weight: 400;
        }

        .thick-font {
          font-weight: 900;
          font-size: 1.1em;
        }

        .full-height {
          height: 100vh;
        }
      </style>
    </custom-style>

    <div class="node-container" class$="{{_computeSmallIndent()}}">
      <div class="node-row">

        <template is="dom-if" if="{{data.children}}">
          <paper-icon-button icon="{{_computeIcon(data.*)}}" on-tap="toggleChildren"></paper-icon-button>
        </template>

        <template is="dom-if" if="{{_computeClickable(data.uid)}}">
          <a href$="{{_computeLink(data.uid)}}">
            <span class="node-name">
              <span class$="data-name {{_computeIndent(data)}}">{{data.name}}
                <span class="data-lang">{{data.lang}}</span>
              </span>
            </span>
          </a>
        </template>

        <template is="dom-if" if="{{!_computeClickable(data.uid)}}">
          <span class="node-name" on-tap="_select">
            <span class$="data-name {{_computeFontWeight(data.uid)}}" inner-h-t-m-l="{{data.name}}">
              <span class="data-lang">{{data.lang}}
              </span>
            </span>
          </span>
        </template>

      </div>

      <iron-collapse id="collapse" opened="{{opened}}">
        <template is="dom-if" if="{{data.open}}">
          <template is="dom-repeat" items="{{data.children}}">
            <paper-tree-node indented id="{{item.uid}}" data="{{item}}"></paper-tree-node>
          </template>
        </template>
        <!--Dummy element that enables rolldown animation with iron-collapse -->
        <template is="dom-if" if="{{!data.open}}">
          <template is="dom-if" if="{{data.children}}">
            <div class="full-height"></div>
          </template>
        </template>
      </iron-collapse>

    </div>
  </template>

  <script>
      class PaperTreeNodeSC extends Polymer.Element {
          static get is() {
              return 'paper-tree-node';
          }

          static get properties() {

              /**
               * Data held by this node (contains the children).
               *
               * Specific data:
               *
               * - `data.name`: string representing the node name.
               * - `data.icon`: string telling which icon to use (default to 'folder' icon).
               * - `data.open`: boolean telling whether the node is expanded or not.
               * - `data.children` array containing the children of the node.
               */

              return {
                  data: {
                      type: Object,
                      notify: true,
                      value: function() {
                          return null;
                      }
                  },
                  indented: {
                      type: Boolean,
                      value: false
                  }
              }
          }

          /**
           * Returns the necessary classes.
           *
           * @param {object} change An object containing the property that changed and its value.
           * @return {string} The class name indicating whether the node is open or closed
           */
          _computeIcon(change) {
              const open = change && change.base && change.base.open;
              const children = change && change.base && change.base.children;
              return ((open && children && children.length) ? 'expand-less' : children && children.length ? 'expand-more' : '');
          }

          _computeIndent(data) {
              // TODO figure out the indentation here
//              return (data.children || data.lang) ? "" : "indent";
          }

          _computeSmallIndent() {
              return this.indented ? "small-indent" : "";
          }

          /**
           * Checks if the element should be a link.
           *
           * @param uid the uid of the menu item, typically looks like this: "root/su1"
           * @returns {boolean} Whether the node should be clickable and should lead to a text / suttaplex list
           */
          _computeClickable(uid) {
              return uid.split("\/")[0] === "root";
          }

          _computeFontWeight(uid) {
              return uid.split("\/")[0] === "grouping" ? "light-font" : "thick-font";
          }

          _computeLink(uid) {
              return uid.substring(uid.indexOf("\/"), uid.length);
          }

          /**
           * Highlights node as the selected node.
           */
          _select() {
              this.dispatchEvent(new CustomEvent("select", { detail: this, composed: true, bubbles: true }));
              this.toggleChildren();
          }

          /**
           * Returns the parent node. Returns `null` if root.
           */
          getParent() {
              return this.domHost.tagName === 'PAPER-TREE-NODE' ? this.domHost : null;
          }

          /**
           * Returns the children tree nodes.
           */
          getChildren() {
              return this.shadowRoot.querySelectorAll('paper-tree-node');
          }

          /**
           * Display/Hide the children nodes.
           */
          toggleChildren() {
              this.opened = !this.opened;
              this.dispatchEvent(new CustomEvent('toggle', { detail: this }));
              this.set("data.open", !this.data.open && this.data.children && this.data.children.length);
          }

      }

      customElements.define(PaperTreeNodeSC.is, PaperTreeNodeSC);
  </script>
</dom-module>
