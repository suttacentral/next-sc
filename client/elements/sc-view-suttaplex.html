<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/iron-dropdown/iron-dropdown-scroll-manager.html">

<link rel="import" href="../elements/suttaplex/sc-title.html">
<link rel="import" href="../elements/suttaplex/sc-suttaplex.html">

<dom-module id="sc-view-suttaplex" attributes="divisionTitle">
  <template>
    <style>
      .division-content {
        color: var(--sc-primary-text-color);
        padding: 0;
      }

      .main {
        margin: var(--sc-size-md-larger) auto;
        max-width: 720px;
      }

      .suttalist {
        margin: 0 auto;
        max-width: 720px;
        transition: margin-top 0.3s, margin-bottom 0.3s;
      }

      .title {
        margin-left: 64px;
      }

      .expandeditem {
        margin-top: 20px;
        margin-bottom: 20px;
      }

      .node {
        padding: var(--sc-size-md) var(--sc-size-md) 0;
        color: var(--sc-secondary-text-color);
      }

      .vagga-node {
        @apply --padding-md;
        color: var(--sc-secondary-text-color);
      }

      .vagga-node.firstvagga, .node + .vagga-node {
        padding-top: 0;
      }

      .loading-spinner {
        --paper-spinner-color: var(--sc-primary-color);
        left: 50%;
        top: 50px;
      }

      :host {
        display: block;
      }

      .suttaplex-list {
        height: 100vh; /* don't use % values unless the parent element is sized. */
      }

      .toast {
        @apply --sc-skolar-font-size-xl;
        --paper-toast-color: var(--sc-tertiary-text-color);
        text-align: center;
        margin-left: calc(50vw - 150px);
      }

      .success-toast {
        --paper-toast-background-color: var(--sc-primary-accent-color);
      }

      .error-toast {
        --paper-toast-background-color: var(--sc-toast-error-color);
      }
    </style>

    <iron-meta id="meta"></iron-meta>

    <iron-ajax
        id="ajax"
        handle-as="json"
        loading="{{ loadingResults }}"
        last-response="{{ responseData }}"></iron-ajax>

    <div class="division-content main">

      <div class="loading-indicator">
        <paper-spinner-lite class="loading-spinner" active="{{loadingResults}}"></paper-spinner-lite>
      </div>

      <iron-list class="suttaplex-list" items="{{responseData}}" as="item" scroll-target="document">
        <template>
          <div>
            <template is="dom-if" if="{{_isSuttaplex(item)}}">
              <sc-suttaplex item="[[item]]"></sc-suttaplex>
            </template>

            <template is="dom-if" if="{{!_isSuttaplex(item)}}">
              <section class$="[[_calculateClass(item.type)]]">
                <sc-title input-title="[[item.original_title]]" input-text="[[item.blurb]]" input-type="[[item.type]]">
                </sc-title>
              </section>
            </template>
          </div>
        </template>
      </iron-list>

    </div>
    <paper-toast id="success_toast" class="toast success-toast" text="[[toastMessage]]" duration=3000></paper-toast>
    <paper-toast id="error_toast" class="toast error-toast" text="[[toastMessage]]" duration=3000></paper-toast>
  </template>

  <script>
      class SCViewSuttaplex extends ReduxMixin(Polymer.Element) {
          static get is() {
              return 'sc-view-suttaplex';
          }

          static get properties() {
              return {
                  responseData: {
                      type: Array,
                      observer: '_responseDataChanged'
                  },
                  categoryId: {
                      type: String,
                      statePath: 'currentRoute.categoryId',
                      observer: '_categoryChanged'
                  },
                  item: {
                    type: Object
                  },
                  toastMessage: {
                    type: String
                  }
              }
          }

          static get actions() {
              return {
                  changeToolbarTitle(title) {
                      return {
                          type: 'CHANGE_TOOLBAR_TITLE',
                          title: title
                      };
                  }
              }
          }

          ready() {
            super.ready();
            this.addEventListener('par-menu-copied', (e) => {
              this.toastMessage = e.detail.message;
              const success = e.detail.success;
              if (success) {
                this.$.success_toast.open();
              } else {
                this.$.error_toast.open();
              }
            })
          }

          _categoryChanged() {
              if (!this.categoryId) {
                  return;
              }
              this.$.ajax.url = `${this.$.meta.byKey('API_ROOT')}\/suttaplex\/${this.categoryId}`;
              this.$.ajax.generateRequest();
          }

          _responseDataChanged() {
              if (!this.responseData) {
                  return;
              }
              this.dispatch('changeToolbarTitle', this.responseData[0].original_title);
          }

          _isSuttaplex(item) {
              return item.type === 'text';
          }

          _calculateClass(itemType) {
              return itemType === 'grouping' ? 'node' : 'vagga-node';
          }
      }

      customElements.define(SCViewSuttaplex.is, SCViewSuttaplex);
  </script>
</dom-module>

